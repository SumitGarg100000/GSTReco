<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free GST Reconciliation tool who reconcile your data within a seconds">
    <meta name="keywords" content="GST,GST Reco, Reconciliation, GST Reconciliation, GSTR-2B, GSTR2B, GSTR-3B, GSTR3B, 2b vs 3b, gst.gov.in, https://www.gst.gov.in/, GST Login">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="GST Reconciliation">
    <meta property="og:image" content="https://sumitgarg100000.github.io/GSTReconciliation/Image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="GST Reconciliation Preview">
    <meta name="google-site-verification" content="FR7D2qkpciz6QmllRnOJ7Mv6bbsFJ1CA6Qn7mYDkqwE" />
    <title>GST Reconciliation Tool - Professional Edition</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Arial, sans-serif;
      }
      
      body {
        background: #f0f8ff;
        color: #333;
        padding: 30px;
      }
      
 .container {
  max-width: 100%; /* Full width */
  width: 98%; /* Slightly less than 100% to avoid edge-to-edge */
  margin: 0 auto;
  background: #fff;
  padding: 20px; /* Reduced padding for compact look */
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0, 61, 115, 0.1);
  min-height: calc(80vh - 40px); /* Reduced height (80% of viewport) */
  display: flex;
  flex-direction: column;
}

.login-card {
  max-width: 95%; /* Increased width for desktop */
  width: 800px; /* Wider for desktop */
  margin: 10px auto; /* Reduced margin for compact look */
  background: white;
  padding: 20px; /* Reduced padding */
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0, 61, 115, 0.1);
  flex-grow: 1;
  overflow-y: auto; /* Scroll within login card */
}


#login-section {
  display: flex;
  flex-direction: column;
  height: 100%;
}
      
      h1 {
        text-align: center;
        color: #0e4377;
        font-size: 2.5em;
        margin-bottom: 20px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }
      
      h2 {
        text-align: center;
        color: #1a5fb4;
        font-size: 1.8em;
        margin: 20px 0;
        padding: 10px;
        background: linear-gradient(to right, #e6f3ff, #f0f8ff);
        border-radius: 8px;
      }
      
      .control-panel {
        background: #f5f9ff;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 4px 10px rgba(0, 61, 115, 0.05);
      }
      
      .options-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: #e6f3ff;
        border-radius: 10px;
        border: 1px solid #cce0ff;
      }
      
      .option-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .button-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
      }
      
      button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
      
      button:active {
        transform: translateY(1px);
      }
      
      #reconcile-btn {
        background: linear-gradient(145deg, #1a73e8, #0d47a1);
        color: white;
      }
      
      #reconcile-btn:hover {
        background: linear-gradient(145deg, #0d47a1, #1a73e8);
      }
      
      #reset-btn {
        background: linear-gradient(145deg, #e53935, #c62828);
        color: white;
      }
      
      #reset-btn:hover {
        background: linear-gradient(145deg, #c62828, #e53935);
      }
      
      #download-sample {
        background: linear-gradient(145deg, #2e7d32, #1b5e20);
        color: white;
      }
      
      #download-sample:hover {
        background: linear-gradient(145deg, #1b5e20, #2e7d32);
      }
      
      .upload-section {
        background: #f0f8ff;
        padding: 15px;
        border-radius: 10px;
        border: 1px dashed #1a73e8;
        margin: 20px 0;
        transition: all 0.3s ease;
      }
      
      .upload-section:hover {
        background: #e6f3ff;
        border-color: #0d47a1;
      }
      
      input[type="file"] {
        padding: 10px;
        border: 2px solid #1a73e8;
        border-radius: 8px;
        background: #f5f9ff;
        width: 100%;
        transition: border-color 0.3s;
      }
      
      input[type="file"]:hover {
        border-color: #0d47a1;
      }
      
      input[type="number"], input[type="checkbox"], input[type="text"], input[type="password"] {
        padding: 10px;
        border: 2px solid #1a73e8;
        border-radius: 8px;
        background: #f5f9ff;
        transition: all 0.3s ease;
      }
      
      input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus {
        border-color: #0d47a1;
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
      }
      
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #1a73e8;
      }
      
      label {
        font-weight: 600;
        color: #0e4377;
      }
      
      .data-container {
        margin: 30px 0;
      }
      
      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 800px;
        margin: 15px 0;
        border: 1px solid #cce0ff;
        border-radius: 8px;
        padding: 5px;
        background: #f5f9ff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      
      table thead th {
        position: sticky;
        top: 0;
        background: #1a73e8;
        color: white;
        z-index: 10;
        border-bottom: 1px solid #0d47a1;
        padding: 12px;
        text-align: left;
      }
      
      th {
        background: #1a73e8;
        color: white;
        font-weight: bold;
        padding: 12px;
        text-align: left;
      }
      
      td {
  border: 1px solid #cce0ff;
  padding: 10px;
  text-align: left;
  /* Remove background-color to allow tr inline styles */
}

tr:nth-child(even) td {
  /* Remove background-color to allow tr inline styles */
}

      
       #tool-section {
        transition: all 0.5s ease;
      }
      
      #login-section.hidden, #tool-section.hidden {
        display: none;
      }
      
      
      
      #error {
        color: #e53935;
        text-align: center;
        margin-top: 10px;
        font-weight: 600;
      }
      
      #expiry-message {
        font-size: 1.2em;
        margin: 10px 0;
        padding: 10px;
        background: #ffebee;
        border-left: 4px solid #e53935;
        border-radius: 4px;
        transition: opacity 0.5s ease;
        color: #e53935;
      }
      .email-section:hover {
  background: #e6f3ff;
  border-color: #0d47a1;
}

#send-email-btn:hover {
  background: linear-gradient(145deg, #f57c00, #ff9800);
}

#email-error {
  color: #e53935;
  font-weight: 600;
}
      
      a#download-output {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 25px;
        background: linear-gradient(145deg, #1a73e8, #0d47a1);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-decoration: none;
        margin: 20px auto;
        text-align: center;
      }
      
      a#download-output:hover {
        background: linear-gradient(145deg, #0d47a1, #1a73e8);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      
      /* Footer Styles */
      footer {
        background: linear-gradient(145deg, #0e4377, #1a5fb4);
        color: #ffffff;
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 30px;
        box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
      }
      
      .footer-content {
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
      }
      
      .footer-links {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 1rem 0;
        flex-wrap: wrap;
      }
      
      .footer-links a {
        color: #ffffff;
        text-decoration: none;
        opacity: 0.9;
        transition: opacity 0.3s ease;
        padding: 5px 10px;
        border-radius: 5px;
      }
      
      .footer-links a:hover {
        opacity: 1;
        text-decoration: underline;
        background: rgba(255, 255, 255, 0.1);
      }
      
      /* WhatsApp & Instructions Buttons */
      .whatsapp-btn, .instructions-btn {
        position: fixed;
        z-index: 1000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        box-shadow: 0 0 20px 10px rgba(37, 211, 102, 0.1);
        animation: glow 3s infinite;
        transition: all 0.3s ease;
      }
      
      .whatsapp-btn {
        bottom: 20px;
        right: 20px;
        background: linear-gradient(145deg, #25d366, #128C7E);
        color: white;
        width: 70px;
        height: 70px;
      }
      
      .instructions-btn {
        bottom: 100px;
        right: 20px;
        background: linear-gradient(145deg, #1a73e8, #0d47a1);
        color: white;
        width: 70px;
        height: 70px;
        border: none;
        cursor: pointer;
      }
      
      .whatsapp-btn:hover, .instructions-btn:hover {
        transform: scale(1.1);
        animation-play-state: paused;
      }
      
      .whatsapp-btn i, .instructions-btn i {
        font-size: 36px;
      }
      
      @keyframes glow {
        0% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
        50% { box-shadow: 0 0 40px 20px rgba(26, 115, 232, 0.1); transform: scale(1.05); }
        100% { box-shadow: 0 0 20px 0px rgba(26, 115, 232, 0.2); transform: scale(1); }
      }
      
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      
      .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 25px;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        position: relative;
      }
      
      .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        color: #0e4377;
        cursor: pointer;
        border: none;
        background: none;
        transition: color 0.3s;
      }
      
      .close-btn:hover {
        color: #e53935;
      }
      
      .modal-content h2 {
        color: #0e4377;
        margin-bottom: 15px;
      }
      
      .modal-content p {
        line-height: 1.6;
        color: #333;
      }
      
      .modal-content h3 {
        color: #1a5fb4;
        margin: 15px 0 10px;
      }
      
      .modal-content ol, .modal-content ul {
        margin-left: 20px;
        margin-bottom: 15px;
      }
      
      .modal-content li {
        margin-bottom: 5px;
      }
      
      /* Filter Dropdown Styles */
      .filter-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .filter-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: white;
        padding: 0;
        margin-left: 5px;
        box-shadow: none;
      }
      
      .filter-dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  min-width: 200px;
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #cce0ff;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 20;
  font-family: 'Segoe UI', Arial, sans-serif; /* Consistent font */
}
      .filter-dropdown-content.show {
  display: block;
}

.filter-input {
  width: 100%;
  padding: 8px;
  border: 1px solid #cce0ff;
  border-radius: 4px;
  margin-bottom: 5px;
  font-size: 14px; /* Match sorting button font size */
  font-weight: 400; /* Normal weight for clarity */
}

.filter-option {
  padding: 8px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px; /* Match sorting button font size */
  font-weight: 400; /* Normal weight for readability */
  color: #333; /* Darker color for visibility */
}

.filter-option:hover {
  background-color: #f0f8ff;
}

.filter-option input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: #1a73e8; /* Blue checkbox to match theme */
}

.filter-option label {
  font-weight: 400; /* Normal weight */
  color: #333; /* Darker for visibility */
}

.filter-actions {
  padding: 8px;
  border-top: 1px solid #cce0ff;
  display: flex;
  justify-content: space-between;
}

.filter-actions button {
  background: #1a73e8; /* Match sorting button background */
  color: white;
  border: none;
  padding: 5px 10px;
  margin: 0 2px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px; /* Match sorting button font size */
  font-weight: 600; /* Match sorting button weight */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
  transition: background 0.3s ease; /* Smooth hover transition */
}

.filter-actions button:hover {
  background: #0d47a1; /* Match sorting button hover */
  transform: none; /* Keep consistent with sorting buttons */
}

.sort-actions {
  padding: 8px;
  border-top: 1px solid #cce0ff;
  display: flex;
  justify-content: space-between;
}

.sort-actions button {
  background: #1a73e8;
  color: white;
  border: none;
  padding: 5px 10px;
  margin: 0 2px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: background 0.3s ease;
}

.sort-actions button:hover {
  background: #0d47a1;
  transform: none;
}
      /* Explanation Section */
      .explanation {
        margin-top: 20px;
        padding: 20px;
        background-color: #f5f9ff;
        border: 1px solid #cce0ff;
        border-radius: 8px;
        overflow-y: auto;
        max-height: calc(100vh - 300px);
      }
      
      .explanation h2, .explanation h3 {
        color: #0e4377;
        background: none;
        text-align: left;
        padding: 0;
      }
      
      .explanation ul, .explanation ol {
        margin-left: 20px;
        margin-bottom: 15px;
      }
      
      .explanation li {
        margin-bottom: 5px;
      }
      
      .youtube-link {
        color: #1a73e8;
        text-decoration: none;
        font-weight: 600;
      }
      
      .youtube-link:hover {
        text-decoration: underline;
      }
         /* Custom Dropdown Styles */
      .custom-select {
        position: relative;
        display: inline-block;
        min-width: 150px;
        margin: 0 10px;
      }
      
      .custom-select select {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #1a73e8;
        border-radius: 8px;
        background-color: #f5f9ff;
        color: #0e4377;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      
      .custom-select select:hover {
        border-color: #0d47a1;
        background-color: #e6f3ff;
      }
      
      .custom-select select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
      }
      
      .custom-select::after {
        content: "\25BC";
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        color: #1a73e8;
        pointer-events: none;
      }
      
      
      /* Responsive Styles */
      @media (max-width: 768px) {
        .options-container {
          flex-direction: column;
        }
        
        .button-container {
          flex-direction: column;
        }
        
        button {
          width: 100%;
        }
        

  
  .container {
    width: 100%; /* Full width on mobile */
    min-height: calc(100vh - 60px); /* Full height on mobile */
    padding: 15px;
  }

  .login-card {
    max-width: 90%;
    width: 100%; /* Responsive width on mobile */
    padding: 15px;
  }

        
        h1 {
          font-size: 2em;
        }
        
        .modal-content {
          width: 95%;
          padding: 15px;
        }
        
        .footer-links {
          flex-direction: column;
          gap: 10px;
        }

.custom-select {
          width: 100%;
          margin: 10px 0;
        }
        
        .email-section .flex {
          flex-direction: column;
          gap: 10px;
        }
        
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Login Section -->
      <div id="login-section">
        <h1 class="mb-6">Login to GST Reconciliation Tool</h1>
        <div class="login-card">
          <div class="mb-6">
            <label for="username" class="block mb-2">Username:</label>
            <input type="text" id="username" value="" placeholder="Enter username" class="w-full">
          </div>
          <div class="mb-6">
            <label for="password" class="block mb-2">Password:</label>
            <input type="password" id="password" value="" placeholder="Enter password" class="w-full">
          </div>
          <div class="flex flex-wrap justify-center gap-4">
            <button onclick="login()" style="background: linear-gradient(145deg, #1a73e8, #0d47a1); color: white;" class="flex-1"><i class="fas fa-sign-in-alt"></i> Login</button>
            <button onclick="freeServiceLogin()" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white;" class="flex-1">
              <i class="fas fa-user-check"></i> Free Service Login
            </button>
          </div>
          <p id="error" class="mt-4"></p>

          <div class="explanation" id="explanation-container">
            <h2 class="text-xl font-bold mb-4">How to Use the GST Reconciliation Tool</h2>
            <p class="mb-4">The GST Reconciliation Tool is designed to help you easily compare and match your GST data from GSTR-2B and GSTR-3B. This guide will walk you through the process step by step.</p>
            <h3 class="text-lg font-bold mb-2">Watch Tutorial Video</h3>
            <p class="mb-4">Check out our step-by-step tutorial video on YouTube to learn how to use the GST Reconciliation Tool effectively:</p>
            <p class="mb-6"><a href="https://youtu.be/pTR1yrEHlrU" class="youtube-link" target="_blank" rel="noopener noreferrer">Click Here</a></p>
            
            <h3 class="text-lg font-bold mb-2">Step-by-Step Guide</h3>
            <ol class="list-decimal ml-6 mb-6">
              <li><strong>Log in</strong>: Use your username and password to access the tool.</li>
              <li><strong>Download Sample File</strong>: Click on "Download Sample Excel File" to get a template for your data.</li>
              <li><strong>Prepare Your Data</strong>: Enter your GSTR-2B data in GST Portal sheet and GSTR-3B or books in client data sheet according to the sample file.</li>
              <li><strong>Upload File</strong>: Upload your prepared Excel file using the "Upload GST Data File" option.</li>
              <li><strong>Set Difference Allowed</strong>: Adjust the tolerance for differences in amounts (default is 1).</li>
              <li><strong>Enable Detailed Reconciliation</strong>: Check this box for detailed reconciliation or leave unchecked for a simple reconciliation.</li>
              <li><strong>Enable Filters (Optional)</strong>: Use filters to sort or search through your data.</li>
              <li><strong>Reconcile Data</strong>: Click "Reconcile" to process and match your data.</li>
              <li><strong>Review Results</strong>: Check the GSTR-2B, GSTR-3B, and Summary tables for matched data.</li>
              <li><strong>Edit Data (If Needed)</strong>: Make direct edits in the tables and reconcile again.</li>
              <li><strong>Download Output</strong>: Click "Download Reconciled Data" to save the results.</li>
            </ol>
            
            <h3 class="text-lg font-bold mb-2">Feature Descriptions</h3>
            <ul class="list-disc ml-6 mb-6">
              <li><strong>Login System</strong>: Secure access with username and password. Subscription status is verified upon login.</li>
              <li><strong>Sample File Download</strong>: Provides a template to ensure your data is correctly formatted.</li>
              <li><strong>File Upload</strong>: Upload your GST data in Excel (.xlsx) format.</li>
              <li><strong>Difference Allowed</strong>: Set the acceptable difference in taxable value, IGST, CGST, and SGST for matching (default: 1).</li>
              <li><strong>Detailed Reconciliation</strong>: When enabled, shows detailed match criteria; when disabled, shows a simplified "Match" or "Unmatch".</li>
              <li><strong>Enable Filters</strong>: Adds dropdown filters to table columns for easy data sorting and searching.</li>
              <li><strong>Reconcile Button</strong>: Processes the data and updates the tables with match results.</li>
              <li><strong>Reset Data Button</strong>: Clears all uploaded data and resets the tool.</li>
              <li><strong>Editable Tables</strong>: Directly edit data in the tables; changes are reflected upon reconciling again.</li>
              <li><strong>Download Reconciled Data</strong>: Generates an Excel file with matched data, including color-coded rows for clarity.</li>
            </ul>
            
            <h3 class="text-lg font-bold mb-2">Understanding Match Criteria</h3>
            <p class="mb-2">When <strong>Detailed Reconciliation</strong> is enabled, the tool uses the following criteria:</p>
            <ul class="list-disc ml-6 mb-4">
              <li><strong>Match - GSTN, Invoice No., Date</strong>: Exact match on GSTN, invoice number, and date.</li>
              <li><strong>Match - GSTN, Invoice No.</strong>: Match on GSTN and invoice number, with possible date differences.</li>
              <li><strong>Match - GSTN, Date</strong>: Match on GSTN and date, with possible invoice number differences.</li>
              <li><strong>Match - GSTN</strong>: Match only on GSTN, with differences in invoice number and date.</li>
              <li><strong>Unmatch - GSTN Not Exist</strong>: GSTN from one sheet is not found in the other.</li>
              <li><strong>Unmatch - Amt Diff</strong>: GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
              <li><strong>Unmatch</strong>: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books</li>
            </ul>
            <p class="mb-2">When <strong>Detailed Reconciliation</strong> is disabled, the criteria are simplified:</p>
            <ul class="list-disc ml-6 mb-4">
              <li><strong>Match</strong>: Data matches based on any of the detailed criteria above.</li>
              <li><strong>Unmatch - GSTN Not Exist</strong>: GSTN from one sheet is not found in the other.</li>
              <li><strong>Unmatch - Amt Diff</strong>: GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
              <li><strong>Unmatch</strong>: Data does not meet any match criteria, generally due to extra invoices in either GSTR-2B or GSTR-3B/Books</li>
            </ul>
            
          </div>
        </div>
      </div>

      <!-- Tool Section -->
      <div id="tool-section" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h1>GST Reconciliation Tool</h1>
          <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
        <p id="expiry-message" style="display: none;" class="text-center"></p>
        
        <div class="control-panel">
          <!-- Sample Download Button -->
          <div class="button-container">
            <button id="download-sample" class="bg-green-600 hover:bg-green-700">
              <i class="fas fa-file-download"></i> Download Sample Excel File
            </button>
          </div>
          
          <!-- Options Container -->
          <div class="options-container">
            <div class="option-group">
              <label for="diff-allowed">Difference Allowed:</label>
              <input type="number" id="diff-allowed" value="1" min="0" class="w-20" placeholder="0 if blank">
              <span class="text-sm text-gray-600">(Default: 1)</span>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="detailed-reconciliation" name="detailed-reconciliation">
              <label for="detailed-reconciliation">Detailed Reconciliation</label>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="enable-filter" name="enable-filter">
              <label for="enable-filter">Enable Filters</label>
            </div>
          </div>
          
          <!-- Upload Section -->
          <div class="upload-section">
            <label for="gst-file" class="block mb-2">
              <i class="fas fa-file-upload mr-2"></i>Upload GST Data File (GSTR-2B & GSTR-3B):
            </label>
            <input type="file" id="gst-file" accept=".xlsx" class="block w-full">
          </div>
          
          <!-- Action Buttons -->
          <div class="button-container">
            <button id="reconcile-btn">
              <i class="fas fa-sync-alt"></i> Reconcile
            </button>
            <button id="reset-btn">
              <i class="fas fa-trash-alt"></i> Reset Data
            </button>
          </div>


     <!-- New Email Section with Dropdown Filters -->
  <div class="email-section" style="background: #f0f8ff; padding: 15px; border-radius: 10px; border: 1px dashed #1a73e8; margin: 20px 0;">
    <h3 class="text-lg font-bold mb-2">Email Reconciliation Results</h3>
    <div class="flex flex-wrap gap-4" mb-4 items-center">
      <div class="flex-1">
        <label for="sender-email" class="block mb-2">Sender Email:</label>
        <input type="email" id="sender-email" placeholder="Enter sender email" class="w-full" required>
      </div>
      <div class="flex-1">
        <label for="receiver-email" class="block mb-2">Receiver Email:</label>
        <input type="email" id="receiver-email" placeholder="Enter receiver email" class="w-full" required>

        
      </div>
    </div>

     <div class="flex items-center justify-center gap-4 flex-wrap">
            <!-- Entry Filter Dropdown -->
            <div class="custom-select">
              <label for="entry-filter" class="block mb-2">Filter Entries:</label>
              <select id="entry-filter">
                <option value="all">All Entries</option>
                <option value="match">Match Only</option>
                <option value="unmatch">Unmatch Only</option>
              </select>
            </div>
       <!-- Send Email Button -->
      <button id="send-email-btn" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white;">
        <i class="fas fa-envelope"></i> Send Email
      </button>
         <!-- Export Format Dropdown -->
            <div class="custom-select">
              <label for="export-format" class="block mb-2">Export Format:</label>
              <select id="export-format">
                <option value="excel">Excel</option>
                <option value="pdf">PDF</option>
                <option value="both">Both</option>
              </select>
            </div>
    </div>
    <p id="email-error" class="text-red-600 text-center mt-2 hidden"></p>
  </div>



          
        </div>
        
        <div class="data-container">
          <h2>GSTR-2B Data</h2>
          <div id="gstr2b-container" class="table-container"></div>
          
          <h2>Client Data</h2>
          <div id="gstr3b-container" class="table-container"></div>
          
          <h2>Summary</h2>
          <div id="summary-container" class="table-container"></div>
        </div>
        
        <div id="output-link" style="display: none;" class="text-center">
          <h3 class="text-xl font-bold text-blue-800 mb-4">Reconciled Output:</h3>
          <a id="download-output" href="#" class="inline-block">
            <i class="fas fa-file-excel mr-2"></i> Download Reconciled Data
          </a>
        </div>
      </div>
    </div>

    <button class="instructions-btn" onclick="showInstructions()" aria-label="View Instructions">
      <i class="fas fa-info-circle"></i>
    </button>
    
    <a href="https://wa.me/9716804520" class="whatsapp-btn" target="_blank" rel="noopener noreferrer" aria-label="Chat on WhatsApp">
      <i class="fab fa-whatsapp"></i>
    </a>
    
    <div id="instructions-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="hideInstructions()">Ãƒâ€”</span>
        <h2>GST Reconciliation Tool</h2>
        <h3>How to Use the Tool</h3>
        
        <h3>Matching Heading Criteria</h3><br>
        <p><strong>When Detailed Reconciliation is checked:</strong></p>
        
        <p><strong>When Detailed Reconciliation is unchecked:</strong></p>
        
      </div>
    </div>
    
    <footer>
      <div class="footer-content">
        <div class="footer-links">
          <a href="#"><i class="fas fa-phone mr-2"></i> Ph: 9716804520</a>
          <a href="#"><i class="fas fa-envelope mr-2"></i> Email: Sumitgarg100000@gmail.com</a>
          <a href="#"><i class="fas fa-map-marker-alt mr-2"></i> Address: Rohini, Delhi-110086</a>
        </div>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <script>
      const users = {
        "Sumitgarg" : { password: "Garg@123", expiry: "2026-04-30"},
        "user1": { password: "pass123", expiry: "2025-04-30" },
        "user2": { password: "pass456", expiry: "2025-05-15" }
      };

       //  if (window.location.href.toLowerCase(). includes("https://sumitgarg100000.github.io")) {
      let gstr2bData = localStorage.getItem('gstr2bData') ? JSON.parse(localStorage.getItem('gstr2bData')) : [];
      let gstr3bData = localStorage.getItem('gstr3bData') ? JSON.parse(localStorage.getItem('gstr3bData')) : [];
      const detailedReconciliationCheckbox = document.getElementById('detailed-reconciliation');

      // ***Change 1: Page Load Check ko Improve Karna***
      document.addEventListener("DOMContentLoaded", function() {
  const loggedInUser = localStorage.getItem("loggedInUser");
  const isFreeService = localStorage.getItem("isFreeService") === "true";

  // Restore email fields from localStorage
  const senderEmail = localStorage.getItem('senderEmail');
  const receiverEmail = localStorage.getItem('receiverEmail');
  if (senderEmail) {
    document.getElementById('sender-email').value = senderEmail;
  }
  if (receiverEmail) {
    document.getElementById('receiver-email').value = receiverEmail;
  }

  if (loggedInUser) {
    if (isFreeService) {
      showTool(); // Free service user, show tool directly
      restrictFreeServiceFeatures(); // Apply free service restrictions
    } else if (checkSubscription(loggedInUser)) {
      showTool(); // Normal user with valid subscription
    } else {
      showLogin(); // Subscription expired, show login
    }
  } else {
    showLogin(); // No user logged in, show login
  }
});
      function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const error = document.getElementById("error");

  console.log("Login attempt with username:", username);
  if (users[username] && users[username].password === password) {
    console.log("User found, checking subscription...");
    if (checkSubscription(username)) {
      console.log("Subscription valid, setting localStorage and showing tool");
      localStorage.setItem("loggedInUser", username);
      localStorage.setItem("isFreeService", "false");
      // Clear email fields and localStorage
      document.getElementById('sender-email').value = '';
      document.getElementById('receiver-email').value = '';
      localStorage.removeItem('senderEmail');
      localStorage.removeItem('receiverEmail');
      showTool();

      const expiryMessage = document.getElementById("expiry-message");
      if (expiryMessage) {
        console.log("Expiry message element found, setting text:", users[username].expiry);
        expiryMessage.textContent = `Subscription Expiry: ${users[username].expiry}`;
        expiryMessage.style.display = "block";
        expiryMessage.style.opacity = "1";

        setTimeout(() => {
          console.log("Hiding expiry message after 10 seconds");
          expiryMessage.style.opacity = "0";
          setTimeout(() => {
            expiryMessage.style.display = "none";
            expiryMessage.style.opacity = "1";
            console.log("Expiry message hidden and reset");
          }, 500);
        }, 10000);
      } else {
        console.error("Expiry message element not found!");
      }

      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      error.textContent = "";
    } else {
      error.textContent = "Your subscription has expired!";
      console.log("Subscription expired for user:", username);
    }
  } else {
    error.textContent = "Invalid username or password!";
    console.log("Invalid username or password for:", username);
  }
}

      function freeServiceLogin() {
  localStorage.setItem("loggedInUser", "freeServiceUser");
  localStorage.setItem("isFreeService", "true"); // Free service flag
  // Clear email fields and localStorage
  document.getElementById('sender-email').value = '';
  document.getElementById('receiver-email').value = '';
  localStorage.removeItem('senderEmail');
  localStorage.removeItem('receiverEmail');
  showTool();
  restrictFreeServiceFeatures(); // Restrictions apply karo
  // Clear input fields after successful login
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error").textContent = ""; // Clear error message if any
}

      // Check Subscription Expiry (No Change Needed)
      function checkSubscription(username) {
        const expiryDate = new Date(users[username].expiry);
        const today = new Date();
        return today <= expiryDate;
      }

      // Logout Function (No Change Needed)
      function logout() {
        localStorage.removeItem("loggedInUser");
        localStorage.removeItem("gstr2bData");
        localStorage.removeItem("gstr3bData");
        localStorage.removeItem("isFreeService"); // Free service flag clear karo
        gstr2bData = [];
        gstr3bData = [];
        resetData();
        showLogin();
        // Clear input fields and reset login section
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("error").textContent = ""; // Clear error message
        // Ensure fields are blank when showing login section
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("error").textContent = "";
      }

      // Show Login Section (No Change Needed)
      function showLogin() {
        document.getElementById("login-section").classList.remove("hidden");
        document.getElementById("tool-section").classList.add("hidden");
      }

      // ***Change 2: Show Tool Function ko Enhance Karna***
      function showTool() {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("tool-section").classList.remove("hidden");

        const isFreeService = localStorage.getItem("isFreeService") === "true";

        // Restore checkbox state only for normal users
        const detailedReconciliationCheckbox = document.getElementById("detailed-reconciliation");
        detailedReconciliationCheckbox.checked = localStorage.getItem('detailedReconciliation') === 'true' && !isFreeService;

        // Add event listeners only once (avoid duplicates)
        const reconcileBtn = document.getElementById('reconcile-btn');
        const downloadSample = document.getElementById('download-sample');
        const diffAllowed = document.getElementById('diff-allowed');
        diffAllowed.value = "1"; // Default to 1 for all users
        const resetBtn = document.getElementById('reset-btn');
        const gstFile = document.getElementById('gst-file');

        reconcileBtn.removeEventListener('click', reconcileData);
        downloadSample.removeEventListener('click', generateSampleFile);
        diffAllowed.removeEventListener('input', reconcileData);
        resetBtn.removeEventListener('click', resetData);
        gstFile.removeEventListener('change', handleFileUpload);

        gstFile.addEventListener('change', handleFileUpload);
        reconcileBtn.addEventListener('click', reconcileData);
        downloadSample.addEventListener('click', generateSampleFile);
        diffAllowed.addEventListener('input', reconcileData);
        resetBtn.addEventListener('click', resetData);

        detailedReconciliationCheckbox.removeEventListener('change', handleCheckboxChange);
        detailedReconciliationCheckbox.addEventListener('change', handleCheckboxChange);
        function handleCheckboxChange() {
          reconcileData();
          localStorage.setItem('detailedReconciliation', detailedReconciliationCheckbox.checked);
        }
        // Save email fields to localStorage on input
document.getElementById('sender-email').addEventListener('input', function() {
  localStorage.setItem('senderEmail', this.value);
});

document.getElementById('receiver-email').addEventListener('input', function() {
  localStorage.setItem('receiverEmail', this.value);
});

        // Restore previous data
        if (gstr2bData.length > 0) {
          displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
        }
        if (gstr3bData.length > 0) {
          displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
        }
        if (gstr2bData.length > 0 || gstr3bData.length > 0) {
          reconcileData();
        }

        // Reset restrictions for normal users and apply for free service users
        const filterCheckbox = document.getElementById("enable-filter");
        if (!isFreeService) {
          detailedReconciliationCheckbox.disabled = false;
          filterCheckbox.disabled = false;
          diffAllowed.disabled = false;
          document.getElementById("free-service-notice")?.remove(); // Remove notice if exists
        }
        restrictFreeServiceFeatures(); // Apply restrictions if free service mode
      }

      function restrictFreeServiceFeatures() {
        const isFreeService = localStorage.getItem("isFreeService") === "true";

        if (isFreeService) {
          // Disable Detailed Reconciliation
          const detailedCheckbox = document.getElementById("detailed-reconciliation");
          detailedCheckbox.checked = false;
          detailedCheckbox.disabled = true;

          // Disable Filter Option
          const filterCheckbox = document.getElementById("enable-filter");
          filterCheckbox.checked = false;
          filterCheckbox.disabled = true;
          filterEnabled = false;
          toggleFilters(); // Filters ko hide karo

          // Disable Difference Allowed with default value 1
          const diffAllowedInput = document.getElementById("diff-allowed");
          diffAllowedInput.value = "1"; // Default to 1 for free users
          diffAllowedInput.disabled = true;

          // Disable Editable Fields in Existing Tables
          const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table");
          tables.forEach(table => {
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
              const cells = row.querySelectorAll("td");
              cells.forEach(cell => {
                cell.setAttribute("contenteditable", "false"); // Force disable
              });
            });
          });

          // Apply colors for free service mode
          applyFreeServiceColors();

          // Add notice
          const toolSection = document.getElementById("tool-section");
          const notice = document.createElement("p");
          notice.id = "free-service-notice";
          notice.style.color = "#e53935";
          notice.style.textAlign = "center";
          notice.style.padding = "10px";
          notice.style.margin = "10px 0";
          notice.style.backgroundColor = "#ffebee";
          notice.style.borderRadius = "8px";
          notice.style.borderLeft = "4px solid #e53935";
          notice.textContent = "In Free Service: Detailed Reconciliation feature, Enable Filter & sorting option, alteration of Difference Allowed limit and facility of editable fields are disabled.";
          if (!document.getElementById("free-service-notice")) {
            toolSection.insertBefore(notice, toolSection.querySelector(".control-panel"));
          }
        }
      }
      // Reset Data Function
      function resetData() {
  gstr2bData = [];
  gstr3bData = [];
  localStorage.removeItem('gstr2bData');
  localStorage.removeItem('gstr3bData');
  localStorage.setItem('detailedReconciliation', false);
  document.getElementById('gstr2b-container').innerHTML = '';
  document.getElementById('gstr3b-container').innerHTML = '';
  document.getElementById('summary-container').innerHTML = '';
  document.getElementById('output-link').style.display = 'none';
  document.getElementById('gst-file').value = ''; // Clear file input
  document.getElementById('diff-allowed').value = '1';
  // Clear email fields and localStorage
  document.getElementById('sender-email').value = '';
  document.getElementById('receiver-email').value = '';
  localStorage.removeItem('senderEmail');
  localStorage.removeItem('receiverEmail');
}

      function formatDate(excelDate) {
        if (!excelDate) return '';
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = date.toUTCString().slice(8, 11);
        const year = date.getUTCFullYear();
        return `${day}-${month}-${year}`;
      }

      const baseGstr2bHeaders = ['Match Criteria', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Invoice type', 'Invoice Date', 'Invoice Value', 'Place of supply', 'Reverse Charge', 'Rate (%)', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
      const extendedGstr2bHeaders = ['Cess', 'GSTR-1/5 Period', 'GSTR-1/5 Filing Date', 'ITC Availability', 'Reason', 'Applicable % of Tax Rate', 'Source', 'IRN', 'IRN Date'];
      function gstr2bHeaders() { return [...baseGstr2bHeaders, ...extendedGstr2bHeaders]; }

      const baseGstr3bHeaders = ['Match Criteria', 'Invoice Date', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
      const extendedGstr3bHeaders = ['Invoice Value'];
      function gstr3bHeaders() { return [...baseGstr3bHeaders, ...extendedGstr3bHeaders]; }

      function generateSampleFile(event) {
        event.preventDefault();
        const wb = XLSX.utils.book_new();
        const gstr2bSampleHeaders = gstr2bHeaders();
        const gstr2bSample = [
          gstr2bSampleHeaders,
          // Match - GSTN, Invoice No., Date (2 entries)
          ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 'Regular', '01-Mar-2025', 11800, 'Maharashtra', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN001', '02-Mar-2025'],
          ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 'Regular', '01-mar-2025', 5900, 'Maharashtra', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN002', '02-Mar-2025'],
          // Match - GSTN, Invoice No. (2 entries, different dates)
          ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 'Regular', '02-Mar-2025', 23600, 'Karnataka', 'N', 9, 20000, 0, 1800, 1800, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN003', '03-Mar-2025'],
          ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 'Regular', '04-Mar-2025', 11800, 'Karnataka', 'N', 9, 10000, 0, 900, 900, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN004', '04-Mar-2025'],
          // Match - GSTN, Date (2 entries, different invoice numbers)
          ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0003', 'Regular', '04-Mar-2025', 14160, 'Tamil Nadu', 'N', 18, 12000, 2160, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN005', '05-Mar-2025'],
          ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0004', 'Regular', '04-Mar-2025', 7080, 'Tamil Nadu', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN006', '05-Mar-2025'],
          // Match - GSTN (2 entries, different invoice numbers and dates)
          ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0005', 'Regular', '31-Mar-2025', 9440, 'Maharashtra', 'N', 18, 8000, 1440, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN007', '06-Mar-2025'],
          ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0006', 'Regular', '31-Mar-2025', 4720, 'Maharashtra', 'N', 18, 4000, 720, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN008', '07-Mar-2025'],
          // Unmatch - GSTN Not Exist (2 entries)
          ['Unmatch - GSTN Not Exist', '99NOTEXIST1234Z', 'Supplier X', 'INV007', 'Regular', '07-Mar-2025', 11800, 'Delhi', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN009', '08-Mar-2025'],
          ['Unmatch - GSTN Not Exist', '99NOTEXIST5678Z', 'Supplier Y', 'INV008', 'Regular', '08-Mar-2025', 5900, 'Delhi', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN010', '09-Mar-2025'],
          // Unmatch - Amt Diff (2 entries, same invoice number, different amounts)
          ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 11802, 'Maharashtra', 'N', 18, 10000, 1802, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN011', '10-Mar-2025'],
          ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 5900, 'Maharashtra', 'N', 5, 5000, 250, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN012', '10-Mar-2025'],
          // Unmatch (2 entries, extra invoices)
          ['Unmatch', '27AABCU9603R1ZM', 'Supplier A', 'INV010', 'Regular', '10-Mar-2025', 7080, 'Maharashtra', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '21-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN013', '11-Mar-2025'],
          ['Unmatch', '29XYZ1234P1ZQ', 'Supplier B', 'INV011', 'Regular', '11-Mar-2025', 9440, 'Karnataka', 'N', 9, 8000, 0, 720, 720, 0, 'Mar-2025', '22-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN014', '12-Mar-2025'],
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(gstr2bSample);
        gstr2bSampleHeaders.forEach((_, index) => {
          const cell = ws1[XLSX.utils.encode_cell({ r: 0, c: index })];
          if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
        });
        XLSX.utils.book_append_sheet(wb, ws1, 'GST Portal');

        const gstr3bSampleHeaders = gstr3bHeaders();
        const gstr3bSample = [
          gstr3bSampleHeaders,
          // Match - GSTN, Invoice No., Date (2 entries)
          ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 10000, 1800, 0, 0, 11800],
          ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 5000, 900, 0, 0, 5900],
          // Match - GSTN, Invoice No. (2 entries, different dates)
          ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 20000, 0, 1800, 1800, 23600],
          ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 10000, 0, 900, 900, 11800],
          // Match - GSTN, Date (2 entries, different invoice numbers)
          ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV003', 12000, 2160, 0, 0, 14160],
          ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV004', 6000, 1080, 0, 0, 7080],
          // Match - GSTN (2 entries, different invoice numbers and dates)
          ['Match - GSTN', '05-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV005', 8000, 1440, 0, 0, 9440],
          ['Match - GSTN', '06-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV006', 4000, 720, 0, 0, 4720],
          // Unmatch - GSTN Not Exist (1 entry, GSTN not in GSTR-2B)
          ['Unmatch - GSTN Not Exist', '07-Mar-2025', '88UNIQUE1234Z', 'Supplier Z', 'INV015', 10000, 1800, 0, 0, 11800],
          // Unmatch - Amt Diff (2 entries, same invoice number, different amounts)
          ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 10000, 1800, 0, 0, 11800], // Differs from GSTR-2B
          ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 5000, 250, 0, 0, 5250],  // Differs from GSTR-2B
          // Unmatch (2 entries, extra invoices)
          ['Unmatch', '12-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV013', 7000, 1260, 0, 0, 8260], // Extra invoice
          ['Unmatch', '13-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV014', 9000, 0, 810, 810, 10620], // Extra invoice
        ];
        const ws2 = XLSX.utils.aoa_to_sheet(gstr3bSample);
        gstr3bSampleHeaders.forEach((_, index) => {
          const cell = ws2[XLSX.utils.encode_cell({ r: 0, c: index })];
          if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
        });
        XLSX.utils.book_append_sheet(wb, ws2, 'Client Data');

        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Sample_GST_Reconciliation.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function normalizeRow(row, headerLength) {
        const normalized = new Array(headerLength).fill('');
        row.forEach((cell, index) => {
          if (index < headerLength) normalized[index] = cell === undefined || cell === null ? '' : cell;
        });
        return normalized;
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd-mmm-yyyy' });
          const gstr2bSheet = workbook.Sheets['GST Portal'];
          if (gstr2bSheet) {
            const rawData = XLSX.utils.sheet_to_json(gstr2bSheet, { header: 1, raw: true, defval: '' });
            gstr2bData = rawData.slice(1).map(row => normalizeRow(row, gstr2bHeaders().length));
            localStorage.setItem('gstr2bData', JSON.stringify(gstr2bData));
            displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
          }
          const gstr3bSheet = workbook.Sheets['Client Data'];
          if (gstr3bSheet) {
            const rawData = XLSX.utils.sheet_to_json(gstr3bSheet, { header: 1, raw: true, defval: '' });
            gstr3bData = rawData.slice(1).map(row => normalizeRow(row, gstr3bHeaders().length));
            localStorage.setItem('gstr3bData', JSON.stringify(gstr3bData));
            displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
          }
          reconcileData();
        };
        reader.readAsArrayBuffer(file);
      }

      function displayData(data, containerId, headers, sheetType) {
  const container = document.getElementById(containerId);
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  let html = '<table><thead><tr>';
  headers.forEach(header => html += `<th>${header}</th>`);
  html += '</tr></thead><tbody>';
  data.forEach((row, rowIndex) => {
    html += `<tr data-row="${rowIndex}" data-sheet="${sheetType}">`;
    headers.forEach((_, colIndex) => {
      const cell = row[colIndex];
      const value = typeof cell === 'number' && (cell > 40000 && cell < 50000) ? formatDate(cell) : (cell === undefined || cell === null ? '' : cell);
      const isEditable = colIndex > 0 && !isFreeService; // Editable only for normal users
      html += `<td contenteditable="${isEditable}" data-col="${colIndex}">${value}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  const table = container.querySelector('table');
  table.addEventListener('input', handleCellEdit);
  if (filterEnabled) toggleFilters(); // Reapply filters if enabled

  // Apply free service restrictions and colors
  if (isFreeService) {
    const cells = table.querySelectorAll("td");
    cells.forEach(cell => {
      cell.setAttribute("contenteditable", "false");
    });
    applyFreeServiceColors(); // Apply colors for free service mode
  }
}

      function handleCellEdit(event) {
        const target = event.target;
        const isFreeService = localStorage.getItem("isFreeService") === "true";

        if (isFreeService) {
          event.preventDefault(); // Prevent editing in free service mode
          target.blur(); // Remove focus from cell
          return;
        }

        if (target.tagName === 'TD' && target.hasAttribute('contenteditable') && target.getAttribute('contenteditable') === 'true') {
          const rowIndex = parseInt(target.parentElement.getAttribute('data-row'), 10);
          const colIndex = parseInt(target.getAttribute('data-col'), 10);
          const sheetType = target.parentElement.getAttribute('data-sheet');
          const newValue = target.textContent.trim();
          if (sheetType === 'gstr2b') {
            gstr2bData[rowIndex][colIndex] = newValue;
            localStorage.setItem('gstr2bData', JSON.stringify(gstr2bData));
          } else if (sheetType === 'gstr3b') {
            gstr3bData[rowIndex][colIndex] = newValue;
            localStorage.setItem('gstr3bData', JSON.stringify(gstr3bData));
          }
          reconcileData();
          // Filter refresh karna jab filter enabled ho
          if (filterEnabled) {
            refreshFilters(sheetType === 'gstr2b' ? 'gstr2b-container' : 'gstr3b-container');
          }
        }
      }

      // Naya function filter refresh ke liye
      function refreshFilters(containerId) {
        const table = document.getElementById(containerId).querySelector('table');
        if (table) {
          const headers = table.querySelectorAll('thead th');
          headers.forEach((th, colIndex) => {
            const dropdown = th.querySelector('.filter-dropdown');
            if (dropdown) {
              const optionsDiv = dropdown.querySelector('.filter-options');
              populateFilterOptions(optionsDiv, containerId, colIndex); // Options refresh karna
              applyFilters(containerId); // Filters reapply karna
            }
          });
        }
      }

      function reconcileData() {
        const diffInput = document.getElementById('diff-allowed').value;
        const diffAllowed = diffInput === '' ? 0 : Number(diffInput) || 1;
        const gstr2bTable = document.querySelector('#gstr2b-container table tbody');
        const gstr3bTable = document.querySelector('#gstr3b-container table tbody');
        const reconciled2bData = [];
        const reconciled3bData = [];

        gstr2bData.forEach((row, index) => {
          const match = findMatch(row, gstr2bData, gstr3bData, false, diffAllowed);
          const newRow = [match, ...row.slice(1)];
          reconciled2bData.push(newRow);
          if (gstr2bTable && gstr2bTable.rows[index]) updateRow(gstr2bTable.rows[index], newRow);
        });

        gstr3bData.forEach((row, index) => {
          const match = findMatch(row, gstr3bData, gstr2bData, true, diffAllowed);
          const newRow = [match, ...row.slice(1)];
          reconciled3bData.push(newRow);
          if (gstr3bTable && gstr3bTable.rows[index]) updateRow(gstr3bTable.rows[index], newRow);
        });

        displaySummary(reconciled2bData, reconciled3bData);
        generateOutput(reconciled2bData, reconciled3bData);

        // Re-apply free service restrictions and ensure colors
        restrictFreeServiceFeatures();
      }
      function updateRow(rowElement, newRow) {
        const match = newRow[0];
        Array.from(rowElement.cells).forEach((cell, index) => {
          cell.textContent = newRow[index];
        });
        colorRow(rowElement, match); // Color apply karo
      }

      function normalizeInvoiceNumber(invNum) {
        return invNum.replace(/[\s\/\\.,"?\']/g, '');
      }

      function findMatch(row, sourceData, compareData, is3b, diffAllowed) {
        const sourceHeaders = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const compareHeaders = is3b ? gstr2bHeaders() : gstr3bHeaders();
        const invDateIdx = sourceHeaders.indexOf('Invoice Date');
        const gstnIdx = sourceHeaders.indexOf('GSTN');
        const invNumIdx = sourceHeaders.indexOf('Invoice Number');
        const compareGstnIdx = compareHeaders.indexOf('GSTN');
        const invDate = String(row[invDateIdx]).toLowerCase().trim();
        const gstn = String(row[gstnIdx]).toLowerCase().trim();
        const invNum = normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase().trim());

        // Debugging: Log input values
        console.log(`Processing row: GSTN=${gstn}, InvNo=${invNum}, Date=${invDate}, is3b=${is3b}`);

        // 1. Match - GSTN, Invoice No., Date
        console.log("Checking Match - GSTN, Invoice No., Date...");
        const sourceTotals = calculateTotals(sourceData, invDate, gstn, invNum, is3b);
        const compareTotals = calculateTotals(compareData, invDate, gstn, invNum, !is3b);
        if (sourceTotals.count > 0 && compareTotals.count > 0) {
          console.log(`Found match on GSTN, InvNo, Date. SourceTotals:`, sourceTotals, `CompareTotals:`, compareTotals);
          if (checkTotals(sourceTotals, compareTotals, diffAllowed)) {
            console.log("Totals match within diffAllowed. Returning Match - GSTN, Invoice No., Date");
            return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No., Date' : 'Match';
          }
          console.log("Totals differ, moving to next check");
        } else {
          console.log("No match on GSTN, InvNo, Date");
        }

        // 2. Match - GSTN, Invoice No.
        console.log("Checking Match - GSTN, Invoice No....");
        const invTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
        const compareInvTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
        if (invTotals.count > 0 && compareInvTotals.count > 0) {
          console.log(`Found match on GSTN, InvNo. InvTotals:`, invTotals, `CompareInvTotals:`, compareInvTotals);
          if (checkTotals(invTotals, compareInvTotals, diffAllowed)) {
            console.log("Totals match within diffAllowed. Returning Match - GSTN, Invoice No.");
            return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No.' : 'Match';
          }
          console.log("Totals differ, moving to next check");
        } else {
          console.log("No match on GSTN, InvNo");
        }

        // 3. Match - GSTN, Date
        console.log("Checking Match - GSTN, Date...");
        const gstnDateTotals = calculateTotalsByGstnDate(sourceData, invDate, gstn, is3b);
        const compareGstnDateTotals = calculateTotalsByGstnDate(compareData, invDate, gstn, !is3b);
        if (gstnDateTotals.count > 0 && compareGstnDateTotals.count > 0) {
          console.log(`Found match on GSTN, Date. GstnDateTotals:`, gstnDateTotals, `CompareGstnDateTotals:`, compareGstnDateTotals);
          if (checkTotals(gstnDateTotals, compareGstnDateTotals, diffAllowed)) {
            console.log("Totals match within diffAllowed. Returning Match - GSTN, Date");
            return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Date' : 'Match';
          }
          console.log("Totals differ, moving to next check");
        } else {
          console.log("No match on GSTN, Date");
        }

        // 4. Match - GSTN
        console.log("Checking Match - GSTN...");
        const gstnTotals = calculateTotalsByGstn(sourceData, gstn, is3b);
        const compareGstnTotals = calculateTotalsByGstn(compareData, gstn, !is3b);
        if (gstnTotals.count > 0 && compareGstnTotals.count > 0) {
          console.log(`Found match on GSTN. GstnTotals:`, gstnTotals, `CompareGstnTotals:`, compareGstnTotals);
          if (checkTotals(gstnTotals, compareGstnTotals, diffAllowed)) {
            console.log("Totals match within diffAllowed. Returning Match - GSTN");
            return detailedReconciliationCheckbox.checked ? 'Match - GSTN' : 'Match';
          }
          console.log("Totals differ, moving to next check");
        } else {
          console.log("No match on GSTN");
        }

        // 5. Unmatch - GSTN Not Exist
        console.log("Checking Unmatch - GSTN Not Exist...");
        const gstnExistsInCompare = compareData.some(r => String(r[compareGstnIdx]).toLowerCase().trim() === gstn);
        if (!gstnExistsInCompare) {
          console.log("GSTN not found in compare data. Returning Unmatch - GSTN Not Exist");
          return 'Unmatch - GSTN Not Exist';
        }
        console.log("GSTN exists in compare data");

        // 6. Unmatch - Amt Diff (Check after GSTN Not Exist)
        console.log("Checking Unmatch - Amt Diff...");
        const amtDiffTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
        const compareAmtDiffTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
        if (amtDiffTotals.count > 0 && compareAmtDiffTotals.count > 0) {
          console.log(`Found GSTN, InvNo match for Amt Diff check. Totals:`, amtDiffTotals, `CompareTotals:`, compareAmtDiffTotals);
          if (!checkTotals(amtDiffTotals, compareAmtDiffTotals, diffAllowed)) {
            console.log("Amounts differ beyond diffAllowed. Returning Unmatch - Amt Diff");
            return 'Unmatch - Amt Diff';
          }
          console.log("Amounts match within diffAllowed, moving to Unmatch");
        } else {
          console.log("No GSTN, InvNo match for Amt Diff");
        }

        // 7. Unmatch
        console.log("No match found. Returning Unmatch");
        return 'Unmatch';
      }

      function calculateTotals(data, invDate, gstn, invNum, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const invDateIdx = headers.indexOf('Invoice Date');
        const gstnIdx = headers.indexOf('GSTN');
        const invNumIdx = headers.indexOf('Invoice Number');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[invDateIdx]).toLowerCase() === invDate && 
              String(row[gstnIdx]).toLowerCase() === gstn && 
              normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase()) === invNum) { // Updated line
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function calculateTotalsByInv(data, gstn, invNum, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const gstnIdx = headers.indexOf('GSTN');
        const invNumIdx = headers.indexOf('Invoice Number');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[gstnIdx]).toLowerCase() === gstn && 
              normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase()) === invNum) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function calculateTotalsByGstnDate(data, invDate, gstn, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const invDateIdx = headers.indexOf('Invoice Date');
        const gstnIdx = headers.indexOf('GSTN');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[invDateIdx]).toLowerCase() === invDate && 
              String(row[gstnIdx]).toLowerCase() === gstn) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function calculateTotalsByGstn(data, gstn, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const gstnIdx = headers.indexOf('GSTN');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[gstnIdx]).toLowerCase() === gstn) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function checkTotals(source, compare, diffAllowed) {
        return Math.abs(source.taxable - compare.taxable) <= diffAllowed &&
               Math.abs(source.igst - compare.igst) <= diffAllowed &&
               Math.abs(source.cgst - compare.cgst) <= diffAllowed &&
               Math.abs(source.sgst - compare.sgst) <= diffAllowed;
      }

      function applyFreeServiceColors() {
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  if (!isFreeService) return;

  // Apply to GSTR-2B and GSTR-3B tables
  const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table, #summary-container table");
  tables.forEach(table => {
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const match = row.cells[0].textContent;
      let backgroundColor = '#f0f0f0'; // Default locked color
      let textColor = 'black';

      if (detailedReconciliationCheckbox.checked) {
        switch (match) {
          case 'Match - GSTN, Invoice No., Date':
            backgroundColor = '#00ced1';
            textColor = 'white';
            break;
          case 'Match - GSTN, Invoice No.':
            backgroundColor = '#4b0082';
            textColor = 'white';
            break;
          case 'Match - GSTN, Date':
            backgroundColor = '#32cd32';
            textColor = 'white';
            break;
          case 'Match - GSTN':
            backgroundColor = '#ffbf00';
            textColor = 'black';
            break;
          case 'Unmatch - GSTN Not Exist':
            backgroundColor = '#dc143c';
            textColor = 'white';
            break;
          case 'Unmatch - Amt Diff':
            backgroundColor = '#ff4500';
            textColor = 'white';
            break;
          case 'Unmatch':
            backgroundColor = '#ff00ff';
            textColor = 'white';
            break;
          default:
            backgroundColor = '#ff00ff';
            textColor = 'white';
            break;
        }
      } else {
        switch (match) {
          case 'Match':
            backgroundColor = '#00ced1';
            textColor = 'white';
            break;
          case 'Unmatch - GSTN Not Exist':
            backgroundColor = '#dc143c';
            textColor = 'white';
            break;
          case 'Unmatch - Amt Diff':
            backgroundColor = '#ff4500';
            textColor = 'white';
            break;
          case 'Unmatch':
            backgroundColor = '#ff00ff';
            textColor = 'white';
            break;
          default:
            backgroundColor = '#ff00ff';
            textColor = 'white';
            break;
        }
      }

      const cells = row.querySelectorAll("td");
      cells.forEach(cell => {
        cell.style.backgroundColor = backgroundColor;
        cell.style.color = textColor;
        cell.style.fontWeight = 'normal';
      });
    });
  });
}
      function colorRow(rowElement, match) {
  rowElement.className = ''; // Clear existing classes
  let backgroundColor = '';
  let textColor = 'white'; // Default to white for visibility

  if (detailedReconciliationCheckbox.checked) {
    switch (match) {
      case 'Match - GSTN, Invoice No., Date':
        backgroundColor = '#00ced1'; // Turquoise
        break;
      case 'Match - GSTN, Invoice No.':
        backgroundColor = '#4b0082'; // Indigo
        break;
      case 'Match - GSTN, Date':
        backgroundColor = '#32cd32'; // Lime Green
        break;
      case 'Match - GSTN':
        backgroundColor = '#ffbf00'; // Amber
        textColor = 'black'; // Black text for better contrast
        break;
      case 'Unmatch - GSTN Not Exist':
        backgroundColor = '#dc143c'; // Crimson
        break;
      case 'Unmatch - Amt Diff':
        backgroundColor = '#ff4500'; // Orange Red
        break;
      default:
        backgroundColor = '#ff00ff'; // Magenta
        break;
    }
  } else {
    switch (match) {
      case 'Match':
        backgroundColor = '#00ced1'; // Turquoise
        break;
      case 'Unmatch - GSTN Not Exist':
        backgroundColor = '#dc143c'; // Crimson
        break;
      case 'Unmatch - Amt Diff':
        backgroundColor = '#ff4500'; // Orange Red
        break;
      default:
        backgroundColor = '#ff00ff'; // Magenta
        break;
    }
  }

  // Apply styles to all cells in the row
  Array.from(rowElement.cells).forEach(cell => {
    cell.style.backgroundColor = backgroundColor;
    cell.style.color = textColor;
    cell.style.fontWeight = 'normal'; // Ensure font is visible
  });
}

      function calculateSummary(data, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        const criteria = detailedReconciliationCheckbox.checked ?
          ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
          ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
        const summary = {};
        criteria.forEach(criterion => {
          summary[criterion] = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
        });
        data.forEach(row => {
          let match = row[0];
          if (!detailedReconciliationCheckbox.checked && 
              ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN'].includes(match)) {
            match = 'Match';
          }
          summary[match].taxable += Number(row[taxableIdx]) || 0;
          summary[match].igst += Number(row[igstIdx]) || 0;
          summary[match].cgst += Number(row[cgstIdx]) || 0;
          summary[match].sgst += Number(row[sgstIdx]) || 0;
        });
        const total = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
        criteria.forEach(criterion => {
          total.taxable += summary[criterion].taxable;
          total.igst += summary[criterion].igst;
          total.cgst += summary[criterion].cgst;
          total.sgst += summary[criterion].sgst;
        });
        return { summary, total };
      }

      function displaySummary(reconciled2bData, reconciled3bData) {
  const gstr2bSummary = calculateSummary(reconciled2bData, false);
  const gstr3bSummary = calculateSummary(reconciled3bData, true);
  const container = document.getElementById('summary-container');
  let html = '<table><thead><tr>';
  html += '<th rowspan="2">Particulars</th>';
  html += '<th colspan="4">GST Portal</th>';
  html += '<th colspan="4">Client Data</th>';
  html += '</tr><tr>';
  ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => html += `<th>${header}</th>`);
  ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => html += `<th>${header}</th>`);
  html += '</tr></thead><tbody>';
  const criteria = detailedReconciliationCheckbox.checked ?
    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
  criteria.forEach(criterion => {
    let backgroundColor = '';
    let textColor = 'white';
    if (detailedReconciliationCheckbox.checked) {
      switch (criterion) {
        case 'Match - GSTN, Invoice No., Date':
          backgroundColor = '#00ced1'; // Turquoise
          break;
        case 'Match - GSTN, Invoice No.':
          backgroundColor = '#4b0082'; // Indigo
          break;
        case 'Match - GSTN, Date':
          backgroundColor = '#32cd32'; // Lime Green
          break;
        case 'Match - GSTN':
          backgroundColor = '#ffbf00'; // Amber
          textColor = 'black';
          break;
        case 'Unmatch - GSTN Not Exist':
          backgroundColor = '#dc143c'; // Crimson
          break;
        case 'Unmatch - Amt Diff':
          backgroundColor = '#ff4500'; // Orange Red
          break;
        default:
          backgroundColor = '#ff00ff'; // Magenta
          break;
      }
    } else {
      switch (criterion) {
        case 'Match':
          backgroundColor = '#00ced1'; // Turquoise
          break;
        case 'Unmatch - GSTN Not Exist':
          backgroundColor = '#dc143c'; // Crimson
          break;
        case 'Unmatch - Amt Diff':
          backgroundColor = '#ff4500'; // Orange Red
          break;
        default:
          backgroundColor = '#ff00ff'; // Magenta
          break;
      }
    }
    html += '<tr>';
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${criterion}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr2bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
    html += `<td style="background-color: ${backgroundColor}; color: ${textColor};">${(gstr3bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
    html += '</tr>';
  });
  html += '<tr style="font-weight: bold;">';
  html += '<td><strong>Total</strong></td>';
  html += `<td><strong>${gstr2bSummary.total.taxable.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.igst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.cgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.sgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.taxable.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.igst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.cgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.sgst.toFixed(2)}</strong></td>`;
  html += '</tr>';
  html += '</tbody></table>';
  container.innerHTML = html;

  // Apply free service colors if needed
  if (localStorage.getItem("isFreeService") === "true") {
    applyFreeServiceColors();
  }
}
      async function generateOutput(reconciled2bData, reconciled3bData) {
        const workbook = new ExcelJS.Workbook();
        const ws1 = workbook.addWorksheet('GST Portal');
        const headerRow1 = ws1.addRow(gstr2bHeaders());
        headerRow1.eachCell(cell => {
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
        });
        reconciled2bData.forEach(row => {
          const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
          const addedRow = ws1.addRow(excelRow);
          applyExcelRowColor(addedRow, row[0], gstr2bHeaders().length);
        });
        const ws2 = workbook.addWorksheet('Client Data');
        const headerRow2 = ws2.addRow(gstr3bHeaders());
        headerRow2.eachCell(cell => {
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
        });
        reconciled3bData.forEach(row => {
          const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
          const addedRow = ws2.addRow(excelRow);
          applyExcelRowColor(addedRow, row[0], gstr3bHeaders().length);
        });
        const ws3 = workbook.addWorksheet('Summary');
        const summaryHeader1 = ws3.addRow(['Particulars', 'GST Portal', '', '', '', 'Client Data', '', '', '']);
        const summaryHeader2 = ws3.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'Taxable Value', 'IGST', 'CGST', 'SGST']);
        ws3.mergeCells('A1:A2');
        ws3.mergeCells('B1:E1');
        ws3.mergeCells('F1:I1');
        [summaryHeader1, summaryHeader2].forEach(row => {
          row.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
          });
        });
        const gstr2bSummary = calculateSummary(reconciled2bData, false);
        const gstr3bSummary = calculateSummary(reconciled3bData, true);
        const criteria = detailedReconciliationCheckbox.checked ?
          ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch'] :
          ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch'];
        criteria.forEach(criterion => {
          ws3.addRow([
            criterion,
            gstr2bSummary.summary[criterion].taxable,
            gstr2bSummary.summary[criterion].igst,
            gstr2bSummary.summary[criterion].cgst,
            gstr2bSummary.summary[criterion].sgst,
            gstr3bSummary.summary[criterion].taxable,
            gstr3bSummary.summary[criterion].igst,
            gstr3bSummary.summary[criterion].cgst,
            gstr3bSummary.summary[criterion].sgst
          ]);
        });

        const totalRow = ws3.addRow([
          'Total',
          gstr2bSummary.total.taxable,
          gstr2bSummary.total.igst,
          gstr2bSummary.total.cgst,
          gstr2bSummary.total.sgst,
          gstr3bSummary.total.taxable,
          gstr3bSummary.total.igst,
          gstr3bSummary.total.cgst,
          gstr3bSummary.total.sgst
        ]);
        totalRow.eachCell(cell => { cell.font = { bold: true }; });
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const link = document.getElementById('download-output');
        link.href = url;
        link.download = 'Reconciled_GST_Data.xlsx';
        document.getElementById('output-link').style.display = 'block';
      }

      function applyExcelRowColor(row, match, columnCount) {
        const colors = detailedReconciliationCheckbox.checked ? {
          'Match - GSTN, Invoice No., Date': 'FF00CED1',
          'Match - GSTN, Invoice No.': 'FF4B0082',
          'Match - GSTN, Date': 'FF32CD32',
          'Match - GSTN': 'FFFFBF00',
          'Unmatch - GSTN Not Exist': 'FFDC143C',
          'Unmatch - Amt Diff': 'FFFF4500', // OrangeRed
          'Unmatch': 'FFFF00FF'
        } : {
          'Match': 'FF00CED1',
          'Unmatch - GSTN Not Exist': 'FFDC143C',
          'Unmatch - Amt Diff': 'FFFF4500', // OrangeRed
          'Unmatch': 'FFFF00FF'
        };
        const color = colors[match] || 'FFFF00FF';
        for (let i = 1; i <= columnCount; i++) {
          const cell = row.getCell(i);
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: color }
          };
          if ((detailedReconciliationCheckbox.checked && 
              ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match)) ||
              (!detailedReconciliationCheckbox.checked && 
              ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match))) {
            cell.font = { color: { argb: 'FFFFFFFF' } };
          }
        }
      }

      // Filter State
      let filterEnabled = false;
      const filters = {};

      // Initialize Filter Checkbox
      document.getElementById('enable-filter').addEventListener('change', function () {
        filterEnabled = this.checked;
        toggleFilters();
      });

      // Toggle Filters On/Off
      function toggleFilters() {
        const containers = ['gstr2b-container', 'gstr3b-container'];
        containers.forEach(containerId => {
          const table = document.getElementById(containerId).querySelector('table');
          if (table) {
            const headers = table.querySelectorAll('thead th');
            headers.forEach((th, colIndex) => {
              if (filterEnabled) {
                addFilterDropdown(th, containerId, colIndex);
              } else {
                removeFilterDropdown(th);
              }
            });
            if (!filterEnabled) {
              resetFilters(containerId);
            }
          }
        });
      }

      // Add Filter Dropdown to Header
      function addFilterDropdown(th, containerId, colIndex) {
        if (th.querySelector('.filter-dropdown')) return; // Avoid duplicates
        const headerText = th.textContent.trim();
        const dropdown = document.createElement('div');
        dropdown.className = 'filter-dropdown';

        const filterBtn = document.createElement('button');
        filterBtn.className = 'filter-btn';
        filterBtn.innerHTML = 'â–¼'; // Down arrow for dropdown
        filterBtn.addEventListener('click', () => toggleDropdown(dropdown));

        const dropdownContent = document.createElement('div');
        dropdownContent.className = 'filter-dropdown-content';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'filter-input';
        input.placeholder = `Filter ${headerText}`;
        input.addEventListener('input', () => filterOptions(input, dropdownContent, containerId, colIndex));

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'filter-options';
        populateFilterOptions(optionsDiv, containerId, colIndex);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'filter-actions';
        const selectAllBtn = document.createElement('button');
        selectAllBtn.textContent = 'Select All';
        selectAllBtn.addEventListener('click', () => selectAllOptions(optionsDiv, containerId, colIndex));
        const uncheckAllBtn = document.createElement('button');
        uncheckAllBtn.textContent = 'Uncheck All';
        uncheckAllBtn.addEventListener('click', () => uncheckAllOptions(optionsDiv, containerId, colIndex));
        actionsDiv.appendChild(selectAllBtn);
        actionsDiv.appendChild(uncheckAllBtn);

        // Sort Buttons
        const sortDiv = document.createElement('div');
        sortDiv.className = 'sort-actions';
        const sortAscBtn = document.createElement('button');
        sortAscBtn.textContent = 'Sort A-Z';
        sortAscBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'asc'));
        const sortDescBtn = document.createElement('button');
        sortDescBtn.textContent = 'Sort Z-A';
        sortDescBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'desc'));
        sortDiv.appendChild(sortAscBtn);
        sortDiv.appendChild(sortDescBtn);

        // Assemble Dropdown Content
        dropdownContent.appendChild(input);
        dropdownContent.appendChild(optionsDiv);
        dropdownContent.appendChild(actionsDiv);
        dropdownContent.appendChild(sortDiv); // Sort buttons ko last mein add kiya
        dropdown.appendChild(filterBtn);
        dropdown.appendChild(dropdownContent);
        th.appendChild(dropdown);
      }

      //Uncheck Filter
      function uncheckAllOptions(optionsDiv, containerId, colIndex) {
        const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        applyFilters(containerId);
      }

      // Remove Filter Dropdown
      function removeFilterDropdown(th) {
        const dropdown = th.querySelector('.filter-dropdown');
        if (dropdown) dropdown.remove();
      }

      // Toggle Dropdown Visibility
      function toggleDropdown(dropdown) {
  const content = dropdown.querySelector('.filter-dropdown-content');
  // Close all other dropdowns
  document.querySelectorAll('.filter-dropdown-content.show').forEach(otherDropdown => {
    if (otherDropdown !== content) {
      otherDropdown.classList.remove('show');
    }
  });
  // Toggle the clicked dropdown
  content.classList.toggle('show');
}

      
    // Function to handle the populateFilterOption and related email functionality
function populateFilterOption() {
  // Get the existing email section
  const emailSection = document.querySelector('.email-section');
  if (!emailSection) return;

  // Clear previous contents of button container to avoid duplicates
  const buttonContainer = emailSection.querySelector('.button-container');
  buttonContainer.innerHTML = '';

  // Create entry type dropdown (left of send email button)
  const entryTypeWrapper = document.createElement('div');
  entryTypeWrapper.className = 'flex-1';
  entryTypeWrapper.innerHTML = `
    <label for="entry-type" class="block mb-2">Select Entries:</label>
    <select id="entry-type" class="w-full p-2 border border-blue-300 rounded">
      <option value="all">All</option>
      <option value="match">Match</option>
      <option value="unmatch">Unmatch</option>
    </select>
  `;

  // Create file format dropdown (right of send email button)
  const fileFormatWrapper = document.createElement('div');
  fileFormatWrapper.className = 'flex-1';
  fileFormatWrapper.innerHTML = `
    <label for="file-format" class="block mb-2">File Format:</label>
    <select id="file-format" class="w-full p-2 border border-blue-300 rounded">
      <option value="excel">Excel</option>
      <option value="pdf">PDF</option>
      <option value="both">Both</option>
    </select>
  `;

  // Create send button
  const sendButtonWrapper = document.createElement('div');
  sendButtonWrapper.className = 'flex-1';
  sendButtonWrapper.innerHTML = `
    <label class="block mb-2">&nbsp;</label>
    <button id="send-email-btn" style="background: linear-gradient(145deg, #ff9800, #f57c00); color: white; width: 100%;" class="p-2 rounded">
      <i class="fas fa-envelope"></i> Send Email
    </button>
  `;

  // Append all elements to button container
  buttonContainer.appendChild(entryTypeWrapper);
  buttonContainer.appendChild(sendButtonWrapper);
  buttonContainer.appendChild(fileFormatWrapper);

  // Remove old event listener and add new one
  const sendEmailBtn = document.getElementById('send-email-btn');
  const oldSendBtn = document.getElementById('send-email-btn');
  if (oldSendBtn) {
    const newSendBtn = oldSendBtn.cloneNode(true);
    oldSendBtn.parentNode.replaceChild(newSendBtn, oldSendBtn);
  }
  
  // Add event listener to send-email-btn
  document.getElementById('send-email-btn').addEventListener('click', prepareEmailDraft);
}

// Function to get common columns between GSTR-2B and GSTR-3B
function getCommonColumns() {
  const gstr2bCols = gstr2bHeaders();
  const gstr3bCols = gstr3bHeaders();
  
  // Define the common columns we want to keep, in the order of GSTR-3B
  const commonColumns = [
    'Match Criteria',
    'Invoice Date',
    'GSTN',
    'Name of Supplier',
    'Invoice Number',
    'Taxable Value',
    'IGST',
    'CGST',
    'SGST',
    'Invoice Value'
  ];
  
  // Filter out columns that don't exist in both
  return commonColumns.filter(col => 
    gstr2bCols.includes(col) && gstr3bCols.includes(col)
  );
}

// Function to filter data based on selected entry type
function filterDataByEntryType(data, entryType) {
  if (entryType === 'all') {
    return data;
  } else if (entryType === 'match') {
    return data.filter(row => {
      const matchCriteria = row[0];
      return matchCriteria.startsWith('Match');
    });
  } else if (entryType === 'unmatch') {
    return data.filter(row => {
      const matchCriteria = row[0];
      return matchCriteria.startsWith('Unmatch');
    });
  }
  return data;
}

// Function to generate Excel file with filtered data
async function generateExcelFile(entryType) {
  const commonColumns = getCommonColumns();
  const workbook = new ExcelJS.Workbook();
  
  // Filter data based on entry type
  const filteredGstr2bData = filterDataByEntryType(reconciled2bData || gstr2bData, entryType);
  const filteredGstr3bData = filterDataByEntryType(reconciled3bData || gstr3bData, entryType);
  
  // Create GSTR-2B worksheet with common columns only
  const ws1 = workbook.addWorksheet('GST Portal');
  const headerRow1 = ws1.addRow(commonColumns);
  headerRow1.eachCell(cell => {
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
  });
  
  // Add filtered data with common columns only
  filteredGstr2bData.forEach(row => {
    const rowData = commonColumns.map(column => {
      const colIndex = gstr2bHeaders().indexOf(column);
      return colIndex >= 0 ? row[colIndex] : '';
    });
    const addedRow = ws1.addRow(rowData);
    applyExcelRowColor(addedRow, row[0], commonColumns.length);
  });
  
  // Create GSTR-3B worksheet with common columns only
  const ws2 = workbook.addWorksheet('Client Data');
  const headerRow2 = ws2.addRow(commonColumns);
  headerRow2.eachCell(cell => {
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
  });
  
  // Add filtered data with common columns only
  filteredGstr3bData.forEach(row => {
    const rowData = commonColumns.map(column => {
      const colIndex = gstr3bHeaders().indexOf(column);
      return colIndex >= 0 ? row[colIndex] : '';
    });
    const addedRow = ws2.addRow(rowData);
    applyExcelRowColor(addedRow, row[0], commonColumns.length);
  });
  
  // Add summary worksheet
  const ws3 = workbook.addWorksheet('Summary');
  addSummarySheet(ws3, filteredGstr2bData, filteredGstr3bData);
  
  // Generate Excel buffer
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  
  return blob;
}

// Function to generate PDF data (can be expanded for actual PDF generation)
async function generatePdfData(entryType) {
  // For simplicity, we'll create a simple text representation
  // In a real implementation, you would use a PDF generation library
  const commonColumns = getCommonColumns();
  
  // Filter data based on entry type
  const filteredGstr2bData = filterDataByEntryType(reconciled2bData || gstr2bData, entryType);
  const filteredGstr3bData = filterDataByEntryType(reconciled3bData || gstr3bData, entryType);
  
  // Create a text representation (this would be replaced with actual PDF generation)
  const pdfData = `
    GST Reconciliation Report
    ========================
    
    GSTR-2B Data:
    ${commonColumns.join(', ')}
    ${filteredGstr2bData.map(row => commonColumns.map(column => {
      const colIndex = gstr2bHeaders().indexOf(column);
      return colIndex >= 0 ? row[colIndex] : '';
    }).join(', ')).join('\n')}
    
    GSTR-3B Data:
    ${commonColumns.join(', ')}
    ${filteredGstr3bData.map(row => commonColumns.map(column => {
      const colIndex = gstr3bHeaders().indexOf(column);
      return colIndex >= 0 ? row[colIndex] : '';
    }).join(', ')).join('\n')}
  `;
  
  // Create a blob for the PDF data
  const blob = new Blob([pdfData], { type: 'application/pdf' });
  return blob;
}

// Function to add summary sheet to workbook
function addSummarySheet(worksheet, filteredGstr2bData, filteredGstr3bData) {
  const summaryHeader1 = worksheet.addRow(['Particulars', 'GST Portal', '', '', '', 'Client Data', '', '', '']);
  const summaryHeader2 = worksheet.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'Taxable Value', 'IGST', 'CGST', 'SGST']);
  worksheet.mergeCells('A1:A2');
  worksheet.mergeCells('B1:E1');
  worksheet.mergeCells('F1:I1');
  
  [summaryHeader1, summaryHeader2].forEach(row => {
    row.eachCell(cell => {
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
    });
  });
  
  const gstr2bSummary = calculateSummary(filteredGstr2bData, false);
  const gstr3bSummary = calculateSummary(filteredGstr3bData, true);
  
  const criteria = detailedReconciliationCheckbox.checked ?
    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
  
  criteria.forEach(criterion => {
    worksheet.addRow([
      criterion,
      gstr2bSummary.summary[criterion]?.taxable || 0,
      gstr2bSummary.summary[criterion]?.igst || 0,
      gstr2bSummary.summary[criterion]?.cgst || 0,
      gstr2bSummary.summary[criterion]?.sgst || 0,
      gstr3bSummary.summary[criterion]?.taxable || 0,
      gstr3bSummary.summary[criterion]?.igst || 0,
      gstr3bSummary.summary[criterion]?.cgst || 0,
      gstr3bSummary.summary[criterion]?.sgst || 0
    ]);
  });
  
  const totalRow = worksheet.addRow([
    'Total',
    gstr2bSummary.total.taxable,
    gstr2bSummary.total.igst,
    gstr2bSummary.total.cgst,
    gstr2bSummary.total.sgst,
    gstr3bSummary.total.taxable,
    gstr3bSummary.total.igst,
    gstr3bSummary.total.cgst,
    gstr3bSummary.total.sgst
  ]);
  
  totalRow.eachCell(cell => { cell.font = { bold: true }; });
}

// Function to prepare email draft with attachments
async function prepareEmailDraft() {
  const senderEmail = document.getElementById('sender-email').value.trim();
  const receiverEmail = document.getElementById('receiver-email').value.trim();
  const entryType = document.getElementById('entry-type').value;
  const fileFormat = document.getElementById('file-format').value;
  const errorElement = document.getElementById('email-error');

  // Validate email addresses
  if (!senderEmail || !receiverEmail) {
    errorElement.textContent = 'Please enter both sender and receiver email addresses.';
    errorElement.classList.remove('hidden');
    return;
  }

  if (!isValidEmail(senderEmail) || !isValidEmail(receiverEmail)) {
    errorElement.textContent = 'Please enter valid email addresses.';
    errorElement.classList.remove('hidden');
    return;
  }

  // Clear error message
  errorElement.textContent = '';
  errorElement.classList.add('hidden');
  
  // Create email subject based on selection
  let subject = 'GST Reconciliation Report - ';
  switch(entryType) {
    case 'all': subject += 'All Entries'; break;
    case 'match': subject += 'Matched Entries'; break;
    case 'unmatch': subject += 'Unmatched Entries'; break;
  }
  
  // Create email body
  let body = `Dear Recipient,

Please find attached the GST Reconciliation report with ${entryType} entries from our system.

This report includes:
- GST Portal (GSTR-2B) data
- Client Data (GSTR-3B) data
- Summary of reconciliation results

`;

  // Add file format details to the body
  switch(fileFormat) {
    case 'excel': body += 'The report is attached in Excel format.'; break;
    case 'pdf': body += 'The report is attached in PDF format.'; break;
    case 'both': body += 'The report is attached in both Excel and PDF formats.'; break;
  }
  
  body += `

Please let me know if you have any questions or need any clarification.

Thank you,
${senderEmail}`;

  // Create mailto URL
  const mailtoUrl = `mailto:${receiverEmail}?from=${senderEmail}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  // Open email client
  try {
    window.location.href = mailtoUrl;
  } catch (e) {
    errorElement.textContent = 'Failed to open email client. Please check your email client settings.';
    errorElement.classList.remove('hidden');
  }
}

// Initialize dropdown after the page loads
document.addEventListener("DOMContentLoaded", function() {
  // Call populate function to set up the dropdowns
  const originalInit = showTool;
  showTool = function() {
    originalInit();
    populateFilterOption();
  };
  
  // If tool is already shown, populate now
  if (!document.getElementById("tool-section").classList.contains("hidden")) {
    populateFilterOption();
  }
});

// Function to validate email addresses (keeping your existing function)
function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}


     //       }   else      {       alert("This GST Reconciliation tool is fully secured by Sumit Garg. If not working or face any problem in accessing then contact to me. Name - Sumit Garg, Ph. No. - 9716804520, Email - SumitGarg100000@Gmail.com ");     }


      
    </script>
  </body>
</html>
