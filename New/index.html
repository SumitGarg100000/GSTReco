<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free GST Reconciliation tool who reconcile your data within a seconds. This GST Reconciliation Tool is designed to help you easily compare and match your GST data from GSTR-2B and GSTR-3B/books.">
    <meta name="keywords" content="GST,GST Reco, Reconciliation, GST Reconciliation, GSTR-2B, GSTR2B, GSTR-3B, GSTR3B, 2b vs 3b, gst.gov.in, https://www.gst.gov.in/, GST Login">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:title" content="GST Reconciliation">
    <meta property="og:image" content="https://sumitgarg100000.github.io/GSTReconciliation/Image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="GST Reconciliation Preview">
    <meta name="google-site-verification" content="FR7D2qkpciz6QmllRnOJ7Mv6bbsFJ1CA6Qn7mYDkqwE" />
    <title>GST Reconciliation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
      }

      body {
        background: linear-gradient(135deg, #e0f7fa, #b2dfdb);
        min-height: 100vh;
        color: #333;
      }

      /* Login Section */
      #login-section {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .login-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 450px;
        text-align: center;
      }

      .login-card h1 {
        color: #00796b;
        font-size: 2em;
        margin-bottom: 20px;
      }

      .input-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .input-group label {
        display: block;
        font-weight: 600;
        color: #00695c;
        margin-bottom: 8px;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #26a69a;
        border-radius: 8px;
        background: #f1f8e9;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .input-group input:focus {
        border-color: #00796b;
        box-shadow: 0 0 8px rgba(0, 121, 107, 0.2);
        outline: none;
      }

      .login-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .login-btn, .free-service-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .login-btn {
        background: linear-gradient(45deg, #26a69a, #00796b);
      }

      .free-service-btn {
        background: linear-gradient(45deg, #ff9800, #f44336);
      }

      .login-btn:hover, .free-service-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }

      #error {
        color: #d32f2f;
        margin-top: 15px;
        font-size: 0.9em;
      }

      .explanation {
        margin-top: 20px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 0.9em;
      }

      .explanation h2, .explanation h3 {
        color: #00796b;
        margin-bottom: 10px;
      }

      .explanation ol, .explanation ul {
        margin-left: 20px;
      }

      /* Tool Section */
      .main-container {
        display: flex;
        min-height: 100vh;
      }

      .sidebar {
        width: 250px;
        background: #004d40;
        color: white;
        padding: 20px;
        position: fixed;
        height: 100%;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      }

      .sidebar h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
      }

      .sidebar a, .sidebar button {
        display: block;
        color: white;
        text-decoration: none;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.1);
        transition: background 0.3s;
      }

      .sidebar button {
        width: 100%;
        border: none;
        cursor: pointer;
        font-size: 1em;
      }

      .sidebar a:hover, .sidebar button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .content {
        margin-left: 250px;
        flex-grow: 1;
        padding: 30px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .header h1 {
        color: #00796b;
        font-size: 2em;
        text-align: center;
      }

      .control-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .control-panel .tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
      }

      .control-panel .tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        color: #00796b;
        transition: color 0.3s, border-bottom 0.3s;
      }

      .control-panel .tab.active {
        color: #004d40;
        border-bottom: 3px solid #00796b;
      }

      .control-panel .tab-content {
        display: none;
      }

      .control-panel .tab-content.active {
        display: block;
      }

      .control-panel .input-group {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
      }

      .control-panel button, .control-panel a {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .control-panel #reconcile-btn {
        background: linear-gradient(45deg, #26a69a, #00796b);
      }

      .control-panel #reset-btn {
        background: linear-gradient(45deg, #ff4444, #cc0000);
      }

      .control-panel a#download-sample {
        background: linear-gradient(45deg, #0288d1, #0277bd);
      }

      .control-panel button:hover, .control-panel a:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }

      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        margin: 20px 0;
        border-radius: 10px;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }

      th, td {
        border: 1px solid #e0e0e0;
        padding: 12px;
        text-align: left;
      }

      th {
        background: #e0f7fa;
        color: #004d40;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      /* Match Criteria Colors */
      .match-gstn-inv-date { background-color: #00ced1 !important; color: white !important; }
      .match-inv { background-color: #4b0082 !important; color: white !important; }
      .match-gstn-date { background-color: #32cd32 !important; color: white !important; }
      .match-gstn { background-color: #ffbf00 !important; color: black !important; }
      .gstn-not-match { background-color: #dc143c !important; color: white !important; }
      .amt-diff { background-color: #ff4500 !important; color: white !important; }
      .no-match { background-color: #ff00ff !important; color: white !important; }
      .match { background-color: #00ced1 !important; color: white !important; }

      /* Filter Dropdown Styles */
      .filter-dropdown {
        position: relative;
        display: inline-block;
      }

      .filter-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #004d40;
        padding: 0 5px;
      }

      .filter-dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 20;
      }

      .filter-dropdown-content.show {
        display: block;
      }

      .filter-input {
        width: 100%;
        padding: 8px;
        border: none;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 5px;
      }

      .filter-option {
        display: flex;
        align-items: center;
        padding: 5px 10px;
      }

      .sort-actions {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #e0e0e0;
      }

      .sort-actions button {
        background: #00796b;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8em;
      }

      .sort-actions button:hover {
        background: #004d40;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }

      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #333;
        cursor: pointer;
        background: none;
        border: none;
      }

      .close-btn:hover {
        color: #d32f2f;
      }

      .modal-content h2, .modal-content h3 {
        color: #00796b;
        margin-bottom: 15px;
      }

      /* WhatsApp and Instructions Buttons */
      .whatsapp-btn, .instructions-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #25d366;
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .instructions-btn {
        bottom: 90px;
        background: #0288d1;
      }

      .whatsapp-btn:hover, .instructions-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      }

      .whatsapp-btn i, .instructions-btn i {
        font-size: 30px;
      }

      /* Footer */
      footer {
        background: #004d40;
        color: white;
        padding: 20px;
        text-align: center;
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .footer-links a {
        color: white;
        text-decoration: none;
        opacity: 0.9;
        transition: opacity 0.3s;
      }

      .footer-links a:hover {
        opacity: 1;
        text-decoration: underline;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .main-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          position: static;
        }

        .content {
          margin-left: 0;
        }

        .control-panel .tabs {
          flex-direction: column;
        }

        .control-panel .input-group {
          flex-direction: column;
        }

        .login-card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Section -->
    <div id="login-section">
      <div class="login-card">
        <h1>Login to GST Reconciliation Tool</h1>
        <div class="input-group">
          <label for="username">Username:</label>
          <input type="text" id="username" placeholder="Enter username">
        </div>
        <div class="input-group">
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter password">
        </div>
        <div class="login-buttons">
          <button class="login-btn" onclick="login()">Login</button>
          <button class="free-service-btn" onclick="freeServiceLogin()">Free Service Login</button>
        </div>
        <p id="error"></p>
        <div class="explanation" id="explanation-container">
          <h2>How to Use the GST Reconciliation Tool</h2>
          <p>The GST Reconciliation Tool is designed to help you easily compare and match your GST data from GSTR-2B and GSTR-3B.</p>
          <h3>Step-by-Step Guide</h3>
          <ol>
            <li><strong>Log in</strong>: Use your username and password to access the tool.</li>
            <li><strong>Download Sample File</strong>: Click on "Download Sample Excel File" to get a template for your data.</li>
            <li><strong>Prepare Your Data</strong>: Enter your GSTR-2B data in GST Portal sheet and GSTR-3B or books in client data sheet according to the sample file.</li>
            <li><strong>Upload File</strong>: Upload your prepared Excel file using the "Upload GST Data File" option.</li>
            <li><strong>Set Difference Allowed</strong>: Adjust the tolerance for differences in amounts (default is 1).</li>
            <li><strong>Enable Detailed Reconciliation</strong>: Check this box for detailed reconciliation or leave unchecked for a simple reconciliation.</li>
            <li><strong>Enable Filters (Optional)</strong>: Use filters to sort or search through your data.</li>
            <li><strong>Reconcile Data</strong>: Click "Reconcile" to process and match your data.</li>
            <li><strong>Review Results</strong>: Check the GSTR-2B, GSTR-3B, and Summary tables for matched data.</li>
            <li><strong>Edit Data (If Needed)</strong>: Make direct edits in the tables and reconcile again.</li>
            <li><strong>Download Output</strong>: Click "Download Reconciled Data" to save the results.</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- Tool Section -->
    <div id="tool-section" class="hidden">
      <div class="main-container">
        <div class="sidebar">
          <h2>GST Reconciliation</h2>
          <button onclick="logout()">Logout</button>
          <a href="#" id="download-sample">Download Sample Excel</a>
        </div>
        <div class="content">
          <div class="header">
            <h1>GST Reconciliation Tool</h1>
          </div>
          <div class="control-panel">
            <div class="tabs">
              <div class="tab active" data-tab="controls">Controls</div>
            </div>
            <div class="tab-content active" id="controls">
              <div class="input-group">
                <div>
                  <label for="diff-allowed">Difference Allowed (Default: 1):</label>
                  <input type="number" id="diff-allowed" value="1" min="0" placeholder="0 if blank">
                </div>
                <div>
                  <label for="gst-file">Upload GST Data File (GSTR-2B & GSTR-3B):</label>
                  <input type="file" id="gst-file" accept=".xlsx">
                </div>
              </div>
              <div class="input-group">
                <div>
                  <input type="checkbox" id="detailed-reconciliation" name="detailed-reconciliation">
                  <label for="detailed-reconciliation">Detailed Reconciliation</label>
                </div>
                <div>
                  <input type="checkbox" id="enable-filter" name="enable-filter">
                  <label for="enable-filter">Enable Filters</label>
                </div>
              </div>
              <div class="input-group">
                <button id="reconcile-btn">Reconcile</button>
                <button id="reset-btn">Reset Data</button>
                <a href="#" id="download-sample">Download Sample Excel</a>
              </div>
            </div>
          </div>
          <div class="data-container">
            <h2>GSTR-2B Data</h2>
            <div id="gstr2b-container" class="table-container"></div>
            <h2>Client Data</h2>
            <div id="gstr3b-container" class="table-container"></div>
            <h2>Summary</h2>
            <div id="summary-container" class="table-container"></div>
          </div>
          <div id="output-link" style="display: none;">
            <h3>Reconciled Output:</h3>
            <a id="download-output" href="#">Download Reconciled Data</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals and Buttons -->
    <button class="instructions-btn" onclick="showInstructions()" aria-label="View Instructions">
      <i class="fas fa-info-circle"></i>
    </button>
    <a href="https://wa.me/9716804520" class="whatsapp-btn" target="_blank" rel="noopener noreferrer" aria-label="Chat on WhatsApp">
      <i class="fab fa-whatsapp"></i>
    </a>
    <div id="instructions-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="hideInstructions()">&times;</button>
        <h2>GST Reconciliation Tool</h2>
        <h3>How to Use the Tool</h3>
        <ol>
          <li>Download the sample Excel file from the link to understand the format.</li>
          <li>Copy and paste your GSTR-2B data into the "GST Portal" sheet from column B.</li>
          <li>Copy and paste your GSTR-3B or books data into the "Client Data" sheet from column B.</li>
          <li>Upload your Excel file on the GST Reconciliation Tool website.</li>
          <li>Set the "Difference Allowed" value (default is 1) to adjust matching tolerance.</li>
          <li>Check "Detailed Reconciliation" for specific match criteria, or leave unchecked for simple Match/Unmatch view.</li>
          <li>Review the tables (GSTR-2B, GSTR-3B, and Summary) for results.</li>
          <li>User can edit values directly on website if needed.</li>
          <li>Download the reconciled output file by clicking "Download Reconciled Data".</li>
          <li>For support, contact Sumit Garg via WhatsApp 9716804520 (click on WhatsApp icon).</li>
        </ol>
        <h3>Matching Heading Criteria</h3>
        <p><strong>When Detailed Reconciliation is checked:</strong></p>
        <ol>
          <li><strong>Match - GSTN, Invoice No., Date</strong> - Matches based on GSTN, Invoice No., and Date.</li>
          <li><strong>Match - GSTN, Invoice No.</strong> - Matches based on GSTN and Invoice No.</li>
          <li><strong>Match - GSTN, Date</strong> - Matches based on GSTN and Date.</li>
          <li><strong>Match - GSTN</strong> - Matches based on GSTN only.</li>
          <li><strong>Unmatch - GSTN Not Exist</strong> - GSTN not found in other sheet.</li>
          <li><strong>Unmatch - Amt Diff</strong> - GSTN and Invoice Number match, but amounts differ.</li>
          <li><strong>Unmatch</strong> - Other reasons, generally due to extra invoices.</li>
        </ol>
        <p><strong>When Detailed Reconciliation is unchecked:</strong></p>
        <ol>
          <li><strong>Match</strong> - Any of the above match conditions met.</li>
          <li><strong>Unmatch - GSTN Not Exist</strong> - GSTN not found in other sheet.</li>
          <li><strong>Unmatch - Amt Diff</strong> - GSTN and Invoice Number match, but amounts differ.</li>
          <li><strong>Unmatch</strong> - Other reasons, generally due to extra invoices.</li>
        </ol>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script>
      const users = {
        "Sumitgarg": { password: "Garg@123", expiry: "2026-04-30" },
        "user1": { password: "pass123", expiry: "2025-04-30" },
        "user2": { password: "pass456", expiry: "2025-05-15" }
      };
    </script>


<script>
        //   if (window.location.href.toLowerCase(). includes("https://sumitgarg100000.github.io/GSTReconciliation/")) {
       let gstr2bData = localStorage.getItem('gstr2bData') ? JSON.parse(localStorage.getItem('gstr2bData')) : [];
  let gstr3bData = localStorage.getItem('gstr3bData') ? JSON.parse(localStorage.getItem('gstr3bData')) : [];
  const detailedReconciliationCheckbox = document.getElementById('detailed-reconciliation');

  // ***Change 1: Page Load Check ko Improve Karna***
  document.addEventListener("DOMContentLoaded", function() {
    const loggedInUser = localStorage.getItem("loggedInUser");
    if (loggedInUser && checkSubscription(loggedInUser)) { // <--- Highlight: Condition Simplified
      showTool(); // Agar user logged in hai aur subscription valid hai, to tool dikhao
    } else {
      showLogin(); // Warna login page dikhao
    }
  });

  // Login Function (No Change Needed)
  function login() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const error = document.getElementById("error");

  if (users[username] && users[username].password === password) {
    if (checkSubscription(username)) {
      localStorage.setItem("loggedInUser", username);
      localStorage.setItem("isFreeService", "false"); // Normal login
      showTool();
      // Clear input fields after successful login
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
      error.textContent = ""; // Clear error message if any
    } else {
      error.textContent = "Your subscription has expired!";
    }
  } else {
    error.textContent = "Invalid username or password!";
  }
}

  function freeServiceLogin() {
  localStorage.setItem("loggedInUser", "freeServiceUser");
  localStorage.setItem("isFreeService", "true"); // Free service flag
  showTool();
  restrictFreeServiceFeatures(); // Restrictions apply karo
  // Clear input fields after successful login
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error").textContent = ""; // Clear error message if any
}

  // Check Subscription Expiry (No Change Needed)
  function checkSubscription(username) {
    const expiryDate = new Date(users[username].expiry);
    const today = new Date();
    return today <= expiryDate;
  }

  // Logout Function (No Change Needed)
  function logout() {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("gstr2bData");
    localStorage.removeItem("gstr3bData");
    localStorage.removeItem("isFreeService"); // Free service flag clear karo
    gstr2bData = [];
    gstr3bData = [];
    resetData();
    showLogin();
    // Clear input fields and reset login section
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error").textContent = ""; // Clear error message
   // Ensure fields are blank when showing login section
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("error").textContent = "";
  }
  

  // Show Login Section (No Change Needed)
  function showLogin() {
    document.getElementById("login-section").classList.remove("hidden");
    document.getElementById("tool-section").classList.add("hidden");
  }

  // ***Change 2: Show Tool Function ko Enhance Karna***
  function showTool() {
  document.getElementById("login-section").classList.add("hidden");
  document.getElementById("tool-section").classList.remove("hidden");

  const isFreeService = localStorage.getItem("isFreeService") === "true";

  // Restore checkbox state only for normal users
  const detailedReconciliationCheckbox = document.getElementById("detailed-reconciliation");
  detailedReconciliationCheckbox.checked = localStorage.getItem('detailedReconciliation') === 'true' && !isFreeService;
  
  // Add event listeners only once (avoid duplicates)
  const reconcileBtn = document.getElementById('reconcile-btn');
  const downloadSample = document.getElementById('download-sample');
  const diffAllowed = document.getElementById('diff-allowed');
    diffAllowed.value = "1"; // Default to 1 for all users
  const resetBtn = document.getElementById('reset-btn');
  const gstFile = document.getElementById('gst-file');

  reconcileBtn.removeEventListener('click', reconcileData);
  downloadSample.removeEventListener('click', generateSampleFile);
  diffAllowed.removeEventListener('input', reconcileData);
  resetBtn.removeEventListener('click', resetData);
  gstFile.removeEventListener('change', handleFileUpload);

  gstFile.addEventListener('change', handleFileUpload);
  reconcileBtn.addEventListener('click', reconcileData);
  downloadSample.addEventListener('click', generateSampleFile);
  diffAllowed.addEventListener('input', reconcileData);
  resetBtn.addEventListener('click', resetData);

  detailedReconciliationCheckbox.removeEventListener('change', handleCheckboxChange);
  detailedReconciliationCheckbox.addEventListener('change', handleCheckboxChange);
  function handleCheckboxChange() {
    reconcileData();
    localStorage.setItem('detailedReconciliation', detailedReconciliationCheckbox.checked);
  }

  // Restore previous data
  if (gstr2bData.length > 0) {
    displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
  }
  if (gstr3bData.length > 0) {
    displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
  }
  if (gstr2bData.length > 0 || gstr3bData.length > 0) {
    reconcileData();
  }

  // Reset restrictions for normal users and apply for free service users
  const filterCheckbox = document.getElementById("enable-filter");
  if (!isFreeService) {
    detailedReconciliationCheckbox.disabled = false;
    filterCheckbox.disabled = false;
    diffAllowed.disabled = false;
    document.getElementById("free-service-notice")?.remove(); // Remove notice if exists
  }
  restrictFreeServiceFeatures(); // Apply restrictions if free service mode
}

function restrictFreeServiceFeatures() {
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  
  if (isFreeService) {
    // Disable Detailed Reconciliation
    const detailedCheckbox = document.getElementById("detailed-reconciliation");
    detailedCheckbox.checked = false;
    detailedCheckbox.disabled = true;

    // Disable Filter Option
    const filterCheckbox = document.getElementById("enable-filter");
    filterCheckbox.checked = false;
    filterCheckbox.disabled = true;
    filterEnabled = false;
    toggleFilters(); // Filters ko hide karo

    // Disable Difference Allowed with default value 1
    const diffAllowedInput = document.getElementById("diff-allowed");
    diffAllowedInput.value = "1"; // Default to 1 for free users
    diffAllowedInput.disabled = true;

    // Disable Editable Fields in Existing Tables
    const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table");
    tables.forEach(table => {
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        cells.forEach(cell => {
          cell.setAttribute("contenteditable", "false"); // Force disable
        });
      });
    });

    // Apply colors for free service mode
    applyFreeServiceColors();

    // Add notice
    const toolSection = document.getElementById("tool-section");
    const notice = document.createElement("p");
    notice.id = "free-service-notice";
    notice.style.color = "#f44336";
    notice.style.textAlign = "center";
    notice.textContent = "In Free Service: Detailed Reconciliation feature, Enable Filter & sorting option, alteration of Difference Allowed limit and facility of editable fields are disabled.";
    if (!document.getElementById("free-service-notice")) {
      toolSection.insertBefore(notice, toolSection.querySelector("h1").nextSibling);
    }
  }
}
      // Reset Data Function
      function resetData() {
        gstr2bData = [];
        gstr3bData = [];
        localStorage.removeItem('gstr2bData');
        localStorage.removeItem('gstr3bData');
        localStorage.setItem('detailedReconciliation', false);
        document.getElementById('gstr2b-container').innerHTML = '';
        document.getElementById('gstr3b-container').innerHTML = '';
        document.getElementById('summary-container').innerHTML = '';
        document.getElementById('output-link').style.display = 'none';
        document.getElementById('gst-file').value = ''; // Clear file input
        document.getElementById('diff-allowed').value = '1';
      }

      function formatDate(dateInput) {
  if (!dateInput) return '';
  
  let date;
  // Handle Excel serial number
  if (typeof dateInput === 'number' && dateInput > 40000 && dateInput < 50000) {
    date = new Date((dateInput - 25569) * 86400 * 1000);
  } else {
    // Handle string date (e.g., "01-Mar-2025", "2025-03-01", or other formats)
    date = new Date(String(dateInput).replace(/(\d{2})-(\w{3})-(\d{4})/, '$2 $1 $3')); // Convert dd-mmm-yyyy to parsable format
    if (isNaN(date.getTime())) {
      date = new Date(dateInput); // Try parsing other formats
    }
  }
  
  if (isNaN(date.getTime())) return String(dateInput); // Return original if invalid
  
  const day = String(date.getUTCDate()).padStart(2, '0');
  const month = date.toLocaleString('en-US', { month: 'short' }); // e.g., "Mar"
  const year = date.getUTCFullYear();
  return `${day}-${month}-${year}`;
}

      const baseGstr2bHeaders = ['Match Criteria', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Invoice type', 'Invoice Date', 'Invoice Value', 'Place of supply', 'Reverse Charge', 'Rate (%)', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
      const extendedGstr2bHeaders = ['Cess', 'GSTR-1/5 Period', 'GSTR-1/5 Filing Date', 'ITC Availability', 'Reason', 'Applicable % of Tax Rate', 'Source', 'IRN', 'IRN Date'];
      function gstr2bHeaders() { return [...baseGstr2bHeaders, ...extendedGstr2bHeaders]; }

      const baseGstr3bHeaders = ['Match Criteria', 'Invoice Date', 'GSTN', 'Name of Supplier', 'Invoice Number', 'Taxable Value', 'IGST', 'CGST', 'SGST'];
      const extendedGstr3bHeaders = ['Invoice Value'];
      function gstr3bHeaders() { return [...baseGstr3bHeaders, ...extendedGstr3bHeaders]; }

      function generateSampleFile(event) {
        event.preventDefault();
        const wb = XLSX.utils.book_new();
        const gstr2bSampleHeaders = gstr2bHeaders();
        const gstr2bSample = [
          gstr2bSampleHeaders,
        // Match - GSTN, Invoice No., Date (2 entries)
    ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 'Regular', '01-Mar-2025', 11800, 'Maharashtra', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN001', '02-Mar-2025'],
    ['Match - GSTN, Invoice No., Date', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 'Regular', '01-mar-2025', 5900, 'Maharashtra', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '15-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN002', '02-Mar-2025'],
    // Match - GSTN, Invoice No. (2 entries, different dates)
    ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 'Regular', '02-Mar-2025', 23600, 'Karnataka', 'N', 9, 20000, 0, 1800, 1800, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN003', '03-Mar-2025'],
    ['Match - GSTN, Invoice No.', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 'Regular', '04-Mar-2025', 11800, 'Karnataka', 'N', 9, 10000, 0, 900, 900, 0, 'Mar-2025', '16-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN004', '04-Mar-2025'],
    // Match - GSTN, Date (2 entries, different invoice numbers)
    ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0003', 'Regular', '04-Mar-2025', 14160, 'Tamil Nadu', 'N', 18, 12000, 2160, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN005', '05-Mar-2025'],
    ['Match - GSTN, Date', '33ABCDE5678F1Z5', 'Supplier C', 'INV0004', 'Regular', '04-Mar-2025', 7080, 'Tamil Nadu', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '17-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN006', '05-Mar-2025'],
    // Match - GSTN (2 entries, different invoice numbers and dates)
    ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0005', 'Regular', '31-Mar-2025', 9440, 'Maharashtra', 'N', 18, 8000, 1440, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN007', '06-Mar-2025'],
    ['Match - GSTN', '27AABCU9603R2ZM', 'Supplier C', 'INV0006', 'Regular', '31-Mar-2025', 4720, 'Maharashtra', 'N', 18, 4000, 720, 0, 0, 0, 'Mar-2025', '31-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN008', '07-Mar-2025'],
    // Unmatch - GSTN Not Exist (2 entries)
    ['Unmatch - GSTN Not Exist', '99NOTEXIST1234Z', 'Supplier X', 'INV007', 'Regular', '07-Mar-2025', 11800, 'Delhi', 'N', 18, 10000, 1800, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN009', '08-Mar-2025'],
    ['Unmatch - GSTN Not Exist', '99NOTEXIST5678Z', 'Supplier Y', 'INV008', 'Regular', '08-Mar-2025', 5900, 'Delhi', 'N', 18, 5000, 900, 0, 0, 0, 'Mar-2025', '19-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN010', '09-Mar-2025'],
    // Unmatch - Amt Diff (2 entries, same invoice number, different amounts)
    ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 11802, 'Maharashtra', 'N', 18, 10000, 1802, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN011', '10-Mar-2025'],
    ['Unmatch - Amt Diff', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 'Regular', '09-Mar-2025', 5900, 'Maharashtra', 'N', 5, 5000, 250, 0, 0, 0, 'Mar-2025', '20-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN012', '10-Mar-2025'],
    // Unmatch (2 entries, extra invoices)
    ['Unmatch', '27AABCU9603R1ZM', 'Supplier A', 'INV010', 'Regular', '10-Mar-2025', 7080, 'Maharashtra', 'N', 18, 6000, 1080, 0, 0, 0, 'Mar-2025', '21-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-1', 'IRN013', '11-Mar-2025'],
    ['Unmatch', '29XYZ1234P1ZQ', 'Supplier B', 'INV011', 'Regular', '11-Mar-2025', 9440, 'Karnataka', 'N', 9, 8000, 0, 720, 720, 0, 'Mar-2025', '22-Mar-2025', 'Yes', 'N/A', 0, 'GSTR-5', 'IRN014', '12-Mar-2025'],

  ];
        const ws1 = XLSX.utils.aoa_to_sheet(gstr2bSample);
        gstr2bSampleHeaders.forEach((_, index) => {
          const cell = ws1[XLSX.utils.encode_cell({ r: 0, c: index })];
          if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
        });
        XLSX.utils.book_append_sheet(wb, ws1, 'GST Portal');

        const gstr3bSampleHeaders = gstr3bHeaders();
        const gstr3bSample = [
          gstr3bSampleHeaders,
          // Match - GSTN, Invoice No., Date (2 entries)
    ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV001', 10000, 1800, 0, 0, 11800],
    ['Match - GSTN, Invoice No., Date', '01-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'inv001', 5000, 900, 0, 0, 5900],
    // Match - GSTN, Invoice No. (2 entries, different dates)
    ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV002', 20000, 0, 1800, 1800, 23600],
    ['Match - GSTN, Invoice No.', '03-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV004', 10000, 0, 900, 900, 11800],
    // Match - GSTN, Date (2 entries, different invoice numbers)
    ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV003', 12000, 2160, 0, 0, 14160],
    ['Match - GSTN, Date', '04-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV004', 6000, 1080, 0, 0, 7080],
    // Match - GSTN (2 entries, different invoice numbers and dates)
    ['Match - GSTN', '05-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV005', 8000, 1440, 0, 0, 9440],
    ['Match - GSTN', '06-Mar-2025', '27AABCU9603R2ZM', 'Supplier C', 'INV006', 4000, 720, 0, 0, 4720],
    // Unmatch - GSTN Not Exist (1 entry, GSTN not in GSTR-2B)
    ['Unmatch - GSTN Not Exist', '07-Mar-2025', '88UNIQUE1234Z', 'Supplier Z', 'INV015', 10000, 1800, 0, 0, 11800],
    // Unmatch - Amt Diff (2 entries, same invoice number, different amounts)
    ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 10000, 1800, 0, 0, 11800], // Differs from GSTR-2B
    ['Unmatch - Amt Diff', '09-Mar-2025', '27AABCU9603R1ZM', 'Supplier A', 'INV009', 5000, 250, 0, 0, 5250],  // Differs from GSTR-2B
    // Unmatch (2 entries, extra invoices)
    ['Unmatch', '12-Mar-2025', '33ABCDE5678F1Z5', 'Supplier C', 'INV013', 7000, 1260, 0, 0, 8260], // Extra invoice
    ['Unmatch', '13-Mar-2025', '29XYZ1234P1ZQ', 'Supplier B', 'INV014', 9000, 0, 810, 810, 10620], // Extra invoice

  ];
        const ws2 = XLSX.utils.aoa_to_sheet(gstr3bSample);
        gstr3bSampleHeaders.forEach((_, index) => {
          const cell = ws2[XLSX.utils.encode_cell({ r: 0, c: index })];
          if (cell) cell.s = { fill: { fgColor: { rgb: 'E0FFFF' } } };
        });
        XLSX.utils.book_append_sheet(wb, ws2, 'Client Data');

        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Sample_GST_Reconciliation.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function normalizeRow(row, headerLength) {
        const normalized = new Array(headerLength).fill('');
        row.forEach((cell, index) => {
          if (index < headerLength) normalized[index] = cell === undefined || cell === null ? '' : cell;
        });
        return normalized;
      }

      function handleFileUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', dateNF: 'dd-mmm-yyyy' });
          const gstr2bSheet = workbook.Sheets['GST Portal'];
          if (gstr2bSheet) {
            const rawData = XLSX.utils.sheet_to_json(gstr2bSheet, { header: 1, raw: true, defval: '' });
            gstr2bData = rawData.slice(1).map(row => normalizeRow(row, gstr2bHeaders().length));
            localStorage.setItem('gstr2bData', JSON.stringify(gstr2bData));
            displayData(gstr2bData, 'gstr2b-container', gstr2bHeaders(), 'gstr2b');
          }
          const gstr3bSheet = workbook.Sheets['Client Data'];
          if (gstr3bSheet) {
            const rawData = XLSX.utils.sheet_to_json(gstr3bSheet, { header: 1, raw: true, defval: '' });
            gstr3bData = rawData.slice(1).map(row => normalizeRow(row, gstr3bHeaders().length));
            localStorage.setItem('gstr3bData', JSON.stringify(gstr3bData));
            displayData(gstr3bData, 'gstr3b-container', gstr3bHeaders(), 'gstr3b');
          }
          reconcileData();
        };
        reader.readAsArrayBuffer(file);
      }

      function displayData(data, containerId, headers, sheetType) {
  const container = document.getElementById(containerId);
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  let html = '<table><thead><tr>';
  headers.forEach(header => html += `<th>${header}</th>`);
  html += '</tr></thead><tbody>';
  data.forEach((row, rowIndex) => {
    html += `<tr data-row="${rowIndex}" data-sheet="${sheetType}">`;
    headers.forEach((header, colIndex) => {
      const cell = row[colIndex];
      // Apply formatDate for Invoice Date column
      const isDateColumn = header === 'Invoice Date';
      const value = isDateColumn ? formatDate(cell) : (cell === undefined || cell === null ? '' : cell);
      const isEditable = colIndex > 0 && !isFreeService;
      html += `<td contenteditable="${isEditable}" data-col="${colIndex}">${value}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  const table = container.querySelector('table');
  table.addEventListener('input', handleCellEdit);
  if (filterEnabled) toggleFilters(); // Reapply filters if enabled
  
  // Apply free service restrictions and colors
  if (isFreeService) {
    const cells = table.querySelectorAll("td");
    cells.forEach(cell => {
      cell.setAttribute("contenteditable", "false");
    });
    applyFreeServiceColors();
  }
}

      function handleCellEdit(event) {
  const target = event.target;
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  
  if (isFreeService) {
    event.preventDefault(); // Prevent editing in free service mode
    target.blur(); // Remove focus from cell
    return;
  }

  if (target.tagName === 'TD' && target.hasAttribute('contenteditable') && target.getAttribute('contenteditable') === 'true') {
    const rowIndex = parseInt(target.parentElement.getAttribute('data-row'), 10);
    const colIndex = parseInt(target.getAttribute('data-col'), 10);
    const sheetType = target.parentElement.getAttribute('data-sheet');
    const newValue = target.textContent.trim();
    if (sheetType === 'gstr2b') {
      gstr2bData[rowIndex][colIndex] = newValue;
      localStorage.setItem('gstr2bData', JSON.stringify(gstr2bData));
    } else if (sheetType === 'gstr3b') {
      gstr3bData[rowIndex][colIndex] = newValue;
      localStorage.setItem('gstr3bData', JSON.stringify(gstr3bData));
    }
    reconcileData();
    // Filter refresh karna jab filter enabled ho
    if (filterEnabled) {
      refreshFilters(sheetType === 'gstr2b' ? 'gstr2b-container' : 'gstr3b-container');
    }
  }
}

// Naya function filter refresh ke liye
function refreshFilters(containerId) {
  const table = document.getElementById(containerId).querySelector('table');
  if (table) {
    const headers = table.querySelectorAll('thead th');
    headers.forEach((th, colIndex) => {
      const dropdown = th.querySelector('.filter-dropdown');
      if (dropdown) {
        const optionsDiv = dropdown.querySelector('.filter-options');
        populateFilterOptions(optionsDiv, containerId, colIndex); // Options refresh karna
        applyFilters(containerId); // Filters reapply karna
      }
    });
  }
}

      function reconcileData() {
  const diffInput = document.getElementById('diff-allowed').value;
  const diffAllowed = diffInput === '' ? 0 : Number(diffInput) || 1;
  const gstr2bTable = document.querySelector('#gstr2b-container table tbody');
  const gstr3bTable = document.querySelector('#gstr3b-container table tbody');
  const reconciled2bData = [];
  const reconciled3bData = [];
  
  gstr2bData.forEach((row, index) => {
    const match = findMatch(row, gstr2bData, gstr3bData, false, diffAllowed);
    const newRow = [match, ...row.slice(1)];
    reconciled2bData.push(newRow);
    if (gstr2bTable && gstr2bTable.rows[index]) updateRow(gstr2bTable.rows[index], newRow);
  });
  
  gstr3bData.forEach((row, index) => {
    const match = findMatch(row, gstr3bData, gstr2bData, true, diffAllowed);
    const newRow = [match, ...row.slice(1)];
    reconciled3bData.push(newRow);
    if (gstr3bTable && gstr3bTable.rows[index]) updateRow(gstr3bTable.rows[index], newRow);
  });
  
  displaySummary(reconciled2bData, reconciled3bData);
  generateOutput(reconciled2bData, reconciled3bData);
  
  // Re-apply free service restrictions and ensure colors
  restrictFreeServiceFeatures();
}
      function updateRow(rowElement, newRow) {
  const match = newRow[0];
  Array.from(rowElement.cells).forEach((cell, index) => {
    cell.textContent = newRow[index];
  });
  colorRow(rowElement, match); // Color apply karo
}

     function normalizeInvoiceNumber(invNum) {
    return invNum.replace(/[\s\/\\.,"?\']/g, '');
}
      
function findMatch(row, sourceData, compareData, is3b, diffAllowed) {
  const sourceHeaders = is3b ? gstr3bHeaders() : gstr2bHeaders();
  const compareHeaders = is3b ? gstr2bHeaders() : gstr3bHeaders();
  const invDateIdx = sourceHeaders.indexOf('Invoice Date');
  const gstnIdx = sourceHeaders.indexOf('GSTN');
  const invNumIdx = sourceHeaders.indexOf('Invoice Number');
  const compareGstnIdx = compareHeaders.indexOf('GSTN');
  const invDate = formatDate(row[invDateIdx]).toLowerCase().trim(); // Normalize date
  const gstn = String(row[gstnIdx]).toLowerCase().trim();
  const invNum = normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase().trim());


  // Debugging: Log input values
  console.log(`Processing row: GSTN=${gstn}, InvNo=${invNum}, Date=${invDate}, is3b=${is3b}`);

  // 1. Match - GSTN, Invoice No., Date
  console.log("Checking Match - GSTN, Invoice No., Date...");
  const sourceTotals = calculateTotals(sourceData, invDate, gstn, invNum, is3b);
  const compareTotals = calculateTotals(compareData, invDate, gstn, invNum, !is3b);
  if (sourceTotals.count > 0 && compareTotals.count > 0) {
    console.log(`Found match on GSTN, InvNo, Date. SourceTotals:`, sourceTotals, `CompareTotals:`, compareTotals);
    if (checkTotals(sourceTotals, compareTotals, diffAllowed)) {
      console.log("Totals match within diffAllowed. Returning Match - GSTN, Invoice No., Date");
      return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No., Date' : 'Match';
    }
    console.log("Totals differ, moving to next check");
  } else {
    console.log("No match on GSTN, InvNo, Date");
  }

  // 2. Match - GSTN, Invoice No.
  console.log("Checking Match - GSTN, Invoice No....");
  const invTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
  const compareInvTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
  if (invTotals.count > 0 && compareInvTotals.count > 0) {
    console.log(`Found match on GSTN, InvNo. InvTotals:`, invTotals, `CompareInvTotals:`, compareInvTotals);
    if (checkTotals(invTotals, compareInvTotals, diffAllowed)) {
      console.log("Totals match within diffAllowed. Returning Match - GSTN, Invoice No.");
      return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Invoice No.' : 'Match';
    }
    console.log("Totals differ, moving to next check");
  } else {
    console.log("No match on GSTN, InvNo");
  }

  // 3. Match - GSTN, Date
  console.log("Checking Match - GSTN, Date...");
  const gstnDateTotals = calculateTotalsByGstnDate(sourceData, invDate, gstn, is3b);
  const compareGstnDateTotals = calculateTotalsByGstnDate(compareData, invDate, gstn, !is3b);
  if (gstnDateTotals.count > 0 && compareGstnDateTotals.count > 0) {
    console.log(`Found match on GSTN, Date. GstnDateTotals:`, gstnDateTotals, `CompareGstnDateTotals:`, compareGstnDateTotals);
    if (checkTotals(gstnDateTotals, compareGstnDateTotals, diffAllowed)) {
      console.log("Totals match within diffAllowed. Returning Match - GSTN, Date");
      return detailedReconciliationCheckbox.checked ? 'Match - GSTN, Date' : 'Match';
    }
    console.log("Totals differ, moving to next check");
  } else {
    console.log("No match on GSTN, Date");
  }

  // 4. Match - GSTN
  console.log("Checking Match - GSTN...");
  const gstnTotals = calculateTotalsByGstn(sourceData, gstn, is3b);
  const compareGstnTotals = calculateTotalsByGstn(compareData, gstn, !is3b);
  if (gstnTotals.count > 0 && compareGstnTotals.count > 0) {
    console.log(`Found match on GSTN. GstnTotals:`, gstnTotals, `CompareGstnTotals:`, compareGstnTotals);
    if (checkTotals(gstnTotals, compareGstnTotals, diffAllowed)) {
      console.log("Totals match within diffAllowed. Returning Match - GSTN");
      return detailedReconciliationCheckbox.checked ? 'Match - GSTN' : 'Match';
    }
    console.log("Totals differ, moving to next check");
  } else {
    console.log("No match on GSTN");
  }

  // 5. Unmatch - GSTN Not Exist
  console.log("Checking Unmatch - GSTN Not Exist...");
  const gstnExistsInCompare = compareData.some(r => String(r[compareGstnIdx]).toLowerCase().trim() === gstn);
  if (!gstnExistsInCompare) {
    console.log("GSTN not found in compare data. Returning Unmatch - GSTN Not Exist");
    return 'Unmatch - GSTN Not Exist';
  }
  console.log("GSTN exists in compare data");

  // 6. Unmatch - Amt Diff (Check after GSTN Not Exist)
  console.log("Checking Unmatch - Amt Diff...");
  const amtDiffTotals = calculateTotalsByInv(sourceData, gstn, invNum, is3b);
  const compareAmtDiffTotals = calculateTotalsByInv(compareData, gstn, invNum, !is3b);
  if (amtDiffTotals.count > 0 && compareAmtDiffTotals.count > 0) {
    console.log(`Found GSTN, InvNo match for Amt Diff check. Totals:`, amtDiffTotals, `CompareTotals:`, compareAmtDiffTotals);
    if (!checkTotals(amtDiffTotals, compareAmtDiffTotals, diffAllowed)) {
      console.log("Amounts differ beyond diffAllowed. Returning Unmatch - Amt Diff");
      return 'Unmatch - Amt Diff';
    }
    console.log("Amounts match within diffAllowed, moving to Unmatch");
  } else {
    console.log("No GSTN, InvNo match for Amt Diff");
  }

  // 7. Unmatch
  console.log("No match found. Returning Unmatch");
  return 'Unmatch';
}

  

      function calculateTotals(data, invDate, gstn, invNum, is3b) {
    const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
    const invDateIdx = headers.indexOf('Invoice Date');
    const gstnIdx = headers.indexOf('GSTN');
    const invNumIdx = headers.indexOf('Invoice Number');
    const taxableIdx = headers.indexOf('Taxable Value');
    const igstIdx = headers.indexOf('IGST');
    const cgstIdx = headers.indexOf('CGST');
    const sgstIdx = headers.indexOf('SGST');
    let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
    data.forEach(row => {
        if (String(row[invDateIdx]).toLowerCase() === invDate && 
            String(row[gstnIdx]).toLowerCase() === gstn && 
            normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase()) === invNum) { // Updated line
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
        }
    });
    return { count, taxable, igst, cgst, sgst };
}

      function calculateTotalsByInv(data, gstn, invNum, is3b) {
    const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
    const gstnIdx = headers.indexOf('GSTN');
    const invNumIdx = headers.indexOf('Invoice Number');
    const taxableIdx = headers.indexOf('Taxable Value');
    const igstIdx = headers.indexOf('IGST');
    const cgstIdx = headers.indexOf('CGST');
    const sgstIdx = headers.indexOf('SGST');
    let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
    data.forEach(row => {
        if (String(row[gstnIdx]).toLowerCase() === gstn && 
            normalizeInvoiceNumber(String(row[invNumIdx]).toLowerCase()) === invNum) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
        }
    });
    return { count, taxable, igst, cgst, sgst };
}

      function calculateTotalsByGstnDate(data, invDate, gstn, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const invDateIdx = headers.indexOf('Invoice Date');
        const gstnIdx = headers.indexOf('GSTN');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[invDateIdx]).toLowerCase() === invDate && 
              String(row[gstnIdx]).toLowerCase() === gstn) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function calculateTotalsByGstn(data, gstn, is3b) {
        const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
        const gstnIdx = headers.indexOf('GSTN');
        const taxableIdx = headers.indexOf('Taxable Value');
        const igstIdx = headers.indexOf('IGST');
        const cgstIdx = headers.indexOf('CGST');
        const sgstIdx = headers.indexOf('SGST');
        let count = 0, taxable = 0, igst = 0, cgst = 0, sgst = 0;
        data.forEach(row => {
          if (String(row[gstnIdx]).toLowerCase() === gstn) {
            count++;
            taxable += Number(row[taxableIdx]) || 0;
            igst += Number(row[igstIdx]) || 0;
            cgst += Number(row[cgstIdx]) || 0;
            sgst += Number(row[sgstIdx]) || 0;
          }
        });
        return { count, taxable, igst, cgst, sgst };
      }

      function checkTotals(source, compare, diffAllowed) {
        return Math.abs(source.taxable - compare.taxable) <= diffAllowed &&
               Math.abs(source.igst - compare.igst) <= diffAllowed &&
               Math.abs(source.cgst - compare.cgst) <= diffAllowed &&
               Math.abs(source.sgst - compare.sgst) <= diffAllowed;
      }

  function applyFreeServiceColors() {
  const isFreeService = localStorage.getItem("isFreeService") === "true";
  if (!isFreeService) return; // Sirf free service mode mein kaam kare

  const tables = document.querySelectorAll("#gstr2b-container table, #gstr3b-container table");
  tables.forEach(table => {
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const match = row.cells[0].textContent; // Match criteria from first cell
      let backgroundColor = "#f0f0f0"; // Default locked color
      let textColor = "black"; // Default text color

      // Match criteria ke hisaab se colors set karo
      if (detailedReconciliationCheckbox.checked) {
        switch (match) {
          case 'Match - GSTN, Invoice No., Date':
            backgroundColor = "#00ced1"; // Turquoise
            textColor = "white";
            break;
          case 'Match - GSTN, Invoice No.':
            backgroundColor = "#4b0082"; // Indigo
            textColor = "white";
            break;
          case 'Match - GSTN, Date':
            backgroundColor = "#32cd32"; // Lime Green
            textColor = "white";
            break;
          case 'Match - GSTN':
            backgroundColor = "#ffbf00"; // Amber
            textColor = "black";
            break;
          case 'Unmatch - GSTN Not Exist':
            backgroundColor = "#dc143c"; // Crimson
            textColor = "white";
            break;
          case 'Unmatch - Amt Diff':
            backgroundColor = "#ff4500"; // Orange Red
            textColor = "white";
            break;
          default:
            backgroundColor = "#ff00ff"; // Magenta
            textColor = "white";
            break;
        }
      } else {
        switch (match) {
          case 'Match':
            backgroundColor = "#00ced1"; // Turquoise
            textColor = "white";
            break;
          case 'Unmatch - GSTN Not Exist':
            backgroundColor = "#dc143c"; // Crimson
            textColor = "white";
            break;
          case 'Unmatch - Amt Diff':
            backgroundColor = "#ff4500"; // Orange Red
            textColor = "white";
            break;
          default:
            backgroundColor = "#ff00ff"; // Magenta
            textColor = "white";
            break;
        }
      }

      // Har cell par color apply karo
      const cells = row.querySelectorAll("td");
      cells.forEach(cell => {
        cell.style.backgroundColor = backgroundColor;
        cell.style.color = textColor;
      });
    });
  });
}

      function colorRow(rowElement, match) {
  rowElement.className = '';
  if (detailedReconciliationCheckbox.checked) {
    switch (match) {
      case 'Match - GSTN, Invoice No., Date': rowElement.classList.add('match-gstn-inv-date'); break;
      case 'Match - GSTN, Invoice No.': rowElement.classList.add('match-inv'); break;
      case 'Match - GSTN, Date': rowElement.classList.add('match-gstn-date'); break;
      case 'Match - GSTN': rowElement.classList.add('match-gstn'); break;
      case 'Unmatch - GSTN Not Exist': rowElement.classList.add('gstn-not-match'); break;
      case 'Unmatch - Amt Diff': rowElement.classList.add('amt-diff'); break;
      default: rowElement.classList.add('no-match'); break;
    }
  } else {
    switch (match) {
      case 'Match': rowElement.classList.add('match'); break;
      case 'Unmatch - GSTN Not Exist': rowElement.classList.add('gstn-not-match'); break;
      case 'Unmatch - Amt Diff': rowElement.classList.add('amt-diff'); break;
      default: rowElement.classList.add('no-match'); break;
    }
  }
}

      function calculateSummary(data, is3b) {
  const headers = is3b ? gstr3bHeaders() : gstr2bHeaders();
  const taxableIdx = headers.indexOf('Taxable Value');
  const igstIdx = headers.indexOf('IGST');
  const cgstIdx = headers.indexOf('CGST');
  const sgstIdx = headers.indexOf('SGST');
  const criteria = detailedReconciliationCheckbox.checked ?
    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
  const summary = {};
  criteria.forEach(criterion => {
    summary[criterion] = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
  });
  data.forEach(row => {
    let match = row[0];
    if (!detailedReconciliationCheckbox.checked && 
        ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN'].includes(match)) {
      match = 'Match';
    }
    summary[match].taxable += Number(row[taxableIdx]) || 0;
    summary[match].igst += Number(row[igstIdx]) || 0;
    summary[match].cgst += Number(row[cgstIdx]) || 0;
    summary[match].sgst += Number(row[sgstIdx]) || 0;
  });
  const total = { taxable: 0, igst: 0, cgst: 0, sgst: 0 };
  criteria.forEach(criterion => {
    total.taxable += summary[criterion].taxable;
    total.igst += summary[criterion].igst;
    total.cgst += summary[criterion].cgst;
    total.sgst += summary[criterion].sgst;
  });
  return { summary, total };
}

      function displaySummary(reconciled2bData, reconciled3bData) {
  const gstr2bSummary = calculateSummary(reconciled2bData, false);
  const gstr3bSummary = calculateSummary(reconciled3bData, true);
  const container = document.getElementById('summary-container');
  let html = '<table><thead><tr>';
  html += '<th rowspan="2">Particulars</th>';
  html += '<th colspan="4">GST Portal</th>';
  html += '<th colspan="4">Client Data</th>';
  html += '</tr><tr>';
  ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => html += `<th>${header}</th>`);
  ['Taxable Value', 'IGST', 'CGST', 'SGST'].forEach(header => html += `<th>${header}</th>`);
  html += '</tr></thead><tbody>';
  const criteria = detailedReconciliationCheckbox.checked ?
    ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'] :
    ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'];
  criteria.forEach(criterion => {
    html += '<tr>';
    html += `<td>${criterion}</td>`;
    html += `<td>${(gstr2bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr2bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr2bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr2bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr3bSummary.summary[criterion]?.taxable || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr3bSummary.summary[criterion]?.igst || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr3bSummary.summary[criterion]?.cgst || 0).toFixed(2)}</td>`;
    html += `<td>${(gstr3bSummary.summary[criterion]?.sgst || 0).toFixed(2)}</td>`;
    html += '</tr>';
  });
  html += '<tr>';
  html += '<td><strong>Total</strong></td>';
  html += `<td><strong>${gstr2bSummary.total.taxable.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.igst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.cgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr2bSummary.total.sgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.taxable.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.igst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.cgst.toFixed(2)}</strong></td>`;
  html += `<td><strong>${gstr3bSummary.total.sgst.toFixed(2)}</strong></td>`;
  html += '</tr>';
  html += '</tbody></table>';
  container.innerHTML = html;
}

      async function generateOutput(reconciled2bData, reconciled3bData) {
        const workbook = new ExcelJS.Workbook();
        const ws1 = workbook.addWorksheet('GST Portal');
        const headerRow1 = ws1.addRow(gstr2bHeaders());
        headerRow1.eachCell(cell => {
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
        });
        reconciled2bData.forEach(row => {
          const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
          const addedRow = ws1.addRow(excelRow);
          applyExcelRowColor(addedRow, row[0], gstr2bHeaders().length);
        });
        const ws2 = workbook.addWorksheet('Client Data');
        const headerRow2 = ws2.addRow(gstr3bHeaders());
        headerRow2.eachCell(cell => {
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
        });
        reconciled3bData.forEach(row => {
          const excelRow = row.map(cell => cell === undefined || cell === null ? '' : cell);
          const addedRow = ws2.addRow(excelRow);
          applyExcelRowColor(addedRow, row[0], gstr3bHeaders().length);
        });
        const ws3 = workbook.addWorksheet('Summary');
        const summaryHeader1 = ws3.addRow(['Particulars', 'GST Portal', '', '', '', 'Client Data', '', '', '']);
        const summaryHeader2 = ws3.addRow(['', 'Taxable Value', 'IGST', 'CGST', 'SGST', 'Taxable Value', 'IGST', 'CGST', 'SGST']);
        ws3.mergeCells('A1:A2');
        ws3.mergeCells('B1:E1');
        ws3.mergeCells('F1:I1');
        [summaryHeader1, summaryHeader2].forEach(row => {
          row.eachCell(cell => {
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0FFFF' } };
          });
        });
        const gstr2bSummary = calculateSummary(reconciled2bData, false);
        const gstr3bSummary = calculateSummary(reconciled3bData, true);
        const criteria = detailedReconciliationCheckbox.checked ?
          ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch'] :
          ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch'];
        criteria.forEach(criterion => {
          ws3.addRow([
            criterion,
            gstr2bSummary.summary[criterion].taxable,
            gstr2bSummary.summary[criterion].igst,
            gstr2bSummary.summary[criterion].cgst,
            gstr2bSummary.summary[criterion].sgst,
            gstr3bSummary.summary[criterion].taxable,
            gstr3bSummary.summary[criterion].igst,
            gstr3bSummary.summary[criterion].cgst,
            gstr3bSummary.summary[criterion].sgst
          ]);
        });
       
        const totalRow = ws3.addRow([
          'Total',
          gstr2bSummary.total.taxable,
          gstr2bSummary.total.igst,
          gstr2bSummary.total.cgst,
          gstr2bSummary.total.sgst,
          gstr3bSummary.total.taxable,
          gstr3bSummary.total.igst,
          gstr3bSummary.total.cgst,
          gstr3bSummary.total.sgst
        ]);
        totalRow.eachCell(cell => { cell.font = { bold: true }; });
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const link = document.getElementById('download-output');
        link.href = url;
        link.download = 'Reconciled_GST_Data.xlsx';
        document.getElementById('output-link').style.display = 'block';
      }

      function applyExcelRowColor(row, match, columnCount) {
  const colors = detailedReconciliationCheckbox.checked ? {
    'Match - GSTN, Invoice No., Date': 'FF00CED1',
    'Match - GSTN, Invoice No.': 'FF4B0082',
    'Match - GSTN, Date': 'FF32CD32',
    'Match - GSTN': 'FFFFBF00',
    'Unmatch - GSTN Not Exist': 'FFDC143C',
    'Unmatch - Amt Diff': 'FFFF4500', // OrangeRed
    'Unmatch': 'FFFF00FF'
  } : {
    'Match': 'FF00CED1',
    'Unmatch - GSTN Not Exist': 'FFDC143C',
    'Unmatch - Amt Diff': 'FFFF4500', // OrangeRed
    'Unmatch': 'FFFF00FF'
  };
  const color = colors[match] || 'FFFF00FF';
  for (let i = 1; i <= columnCount; i++) {
    const cell = row.getCell(i);
    cell.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: color }
    };
    if ((detailedReconciliationCheckbox.checked && 
        ['Match - GSTN, Invoice No., Date', 'Match - GSTN, Invoice No.', 'Match - GSTN, Date', 'Match - GSTN', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match)) ||
        (!detailedReconciliationCheckbox.checked && 
        ['Match', 'Unmatch - GSTN Not Exist', 'Unmatch - Amt Diff', 'Unmatch'].includes(match))) {
      cell.font = { color: { argb: 'FFFFFFFF' } };
    }
  }
}

//      }   else      {       alert("Don't waste your time for copying. This file is fully secured by Sumit Garg. If any query, Contact - Sumit Garg, Ph. No. - 9716804520, Email - SumitGarg100000@Gmail.com ");     }
      
    </script>

<script>

  // Filter State
let filterEnabled = false;
const filters = {};

// Initialize Filter Checkbox
document.getElementById('enable-filter').addEventListener('change', function () {
  filterEnabled = this.checked;
  toggleFilters();
});

// Toggle Filters On/Off
function toggleFilters() {
  const containers = ['gstr2b-container', 'gstr3b-container'];
  containers.forEach(containerId => {
    const table = document.getElementById(containerId).querySelector('table');
    if (table) {
      const headers = table.querySelectorAll('thead th');
      headers.forEach((th, colIndex) => {
        if (filterEnabled) {
          addFilterDropdown(th, containerId, colIndex);
        } else {
          removeFilterDropdown(th);
        }
      });
      if (!filterEnabled) {
        resetFilters(containerId);
      }
    }
  });
}

// Add Filter Dropdown to Header
function addFilterDropdown(th, containerId, colIndex) {
  if (th.querySelector('.filter-dropdown')) return; // Avoid duplicates
  const headerText = th.textContent.trim();
  const dropdown = document.createElement('div');
  dropdown.className = 'filter-dropdown';

  const filterBtn = document.createElement('button');
  filterBtn.className = 'filter-btn';
  filterBtn.innerHTML = '▼'; // Down arrow for dropdown
  filterBtn.addEventListener('click', () => toggleDropdown(dropdown));

  const dropdownContent = document.createElement('div');
  dropdownContent.className = 'filter-dropdown-content';

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'filter-input';
  input.placeholder = `Filter ${headerText}`;
  input.addEventListener('input', () => filterOptions(input, dropdownContent, containerId, colIndex));

  const optionsDiv = document.createElement('div');
  optionsDiv.className = 'filter-options';
  populateFilterOptions(optionsDiv, containerId, colIndex);

  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'filter-actions';
  const selectAllBtn = document.createElement('button');
  selectAllBtn.textContent = 'Select All';
  selectAllBtn.addEventListener('click', () => selectAllOptions(optionsDiv, containerId, colIndex));
  const uncheckAllBtn = document.createElement('button');
  uncheckAllBtn.textContent = 'Uncheck All';
  uncheckAllBtn.addEventListener('click', () => uncheckAllOptions(optionsDiv, containerId, colIndex));
  actionsDiv.appendChild(selectAllBtn);
  actionsDiv.appendChild(uncheckAllBtn);

  // Sort Buttons
  const sortDiv = document.createElement('div');
  sortDiv.className = 'sort-actions';
  const sortAscBtn = document.createElement('button');
  sortAscBtn.textContent = 'Sort A-Z';
  sortAscBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'asc'));
  const sortDescBtn = document.createElement('button');
  sortDescBtn.textContent = 'Sort Z-A';
  sortDescBtn.addEventListener('click', () => sortTable(containerId, colIndex, 'desc'));
  sortDiv.appendChild(sortAscBtn);
  sortDiv.appendChild(sortDescBtn);

  // Assemble Dropdown Content
  dropdownContent.appendChild(input);
  dropdownContent.appendChild(optionsDiv);
  dropdownContent.appendChild(actionsDiv);
  dropdownContent.appendChild(sortDiv); // Sort buttons ko last mein add kiya
  dropdown.appendChild(filterBtn);
  dropdown.appendChild(dropdownContent);
  th.appendChild(dropdown);
}


//Uncheck Filter
function uncheckAllOptions(optionsDiv, containerId, colIndex) {
  const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  applyFilters(containerId);
}

// Remove Filter Dropdown
function removeFilterDropdown(th) {
  const dropdown = th.querySelector('.filter-dropdown');
  if (dropdown) dropdown.remove();
}

// Toggle Dropdown Visibility
function toggleDropdown(dropdown) {
  const content = dropdown.querySelector('.filter-dropdown-content');
  content.classList.toggle('show');
}

// Populate Filter Options
function populateFilterOptions(optionsDiv, containerId, colIndex) {
  const table = document.getElementById(containerId).querySelector('table');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const uniqueValues = new Set(rows.map(row => row.cells[colIndex].textContent.trim()));
  optionsDiv.innerHTML = '';
  uniqueValues.forEach(value => {
    const option = document.createElement('div');
    option.className = 'filter-option';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = value;
    checkbox.checked = true; // Default all selected
    checkbox.addEventListener('change', () => applyFilters(containerId));
    const label = document.createElement('label');
    label.textContent = value || '(Blank)';
    option.appendChild(checkbox);
    option.appendChild(label);
    optionsDiv.appendChild(option);
  });
}

//Filter Sort Function
function sortTable(containerId, colIndex, direction) {
  const table = document.getElementById(containerId).querySelector('table');
  const rows = Array.from(table.querySelectorAll('tbody tr'));

  rows.sort((a, b) => {
    // ***Change 1: Values ko lowercase mein normalize karna***
    const aValue = a.cells[colIndex].textContent.trim().toLowerCase(); // <--- Highlight: toLowerCase() added
    const bValue = b.cells[colIndex].textContent.trim().toLowerCase(); // <--- Highlight: toLowerCase() added

    // Check if this is the GSTN column (assuming GSTN is at index 1 in GSTR-2B and 2 in GSTR-3B)
    const isGSTNColumn = (containerId === 'gstr2b-container' && colIndex === 1) || 
                         (containerId === 'gstr3b-container' && colIndex === 2);

    if (isGSTNColumn) {
      // Custom GSTN sorting
      // ***Change 2: State code aur rest ko bhi lowercase mein handle karna already hai, koi extra change nahi***
      const aStateCode = parseInt(aValue.slice(0, 2), 10); // First 2 digits as number
      const bStateCode = parseInt(bValue.slice(0, 2), 10);
      const aRest = aValue.slice(2); // Rest of the GSTN
      const bRest = bValue.slice(2);

      // Compare state codes first (numeric)
      if (aStateCode !== bStateCode) {
        return direction === 'asc' ? aStateCode - bStateCode : bStateCode - aStateCode;
      }

      // If state codes are equal, compare the rest (alphanumeric)
      return direction === 'asc' 
        ? aRest.localeCompare(bRest, undefined, { numeric: true, sensitivity: 'base' })
        : bRest.localeCompare(aRest, undefined, { numeric: true, sensitivity: 'base' });
    }

    // Existing logic for other columns
    // ***Change 3: Numbers ke liye bhi case-insensitive nahi chahiye, koi change nahi yahan***
    const aNum = parseFloat(aValue);
    const bNum = parseFloat(bValue);
    if (!isNaN(aNum) && !isNaN(bNum)) {
      return direction === 'asc' ? aNum - bNum : bNum - aNum;
    }

    // ***Change 4: Dates ke liye bhi case-insensitive nahi chahiye, lekin format consistency ke liye toLowerCase() pehle hi hai***
    const aDate = Date.parse(aValue);
    const bDate = Date.parse(bValue);
    if (!isNaN(aDate) && !isNaN(bDate)) {
      return direction === 'asc' ? aDate - bDate : bDate - aDate;
    }

    // ***Change 5: Strings ke liye case-insensitive already sensitivity: 'base' se handle ho raha hai, bas toLowerCase() upar add kiya***
    return direction === 'asc' 
      ? aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' })
      : bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' });
  });

  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
  applyFilters(containerId); // Filters reapply karna
}

// Filter Options Based on Input
function filterOptions(input, dropdownContent, containerId, colIndex) {
  const filterText = input.value.toLowerCase();
  const optionsDiv = dropdownContent.querySelector('.filter-options');
  const options = optionsDiv.querySelectorAll('.filter-option');
  options.forEach(option => {
    const label = option.querySelector('label').textContent.toLowerCase();
    option.style.display = label.includes(filterText) ? 'flex' : 'none';
  });
  applyFilters(containerId);
}

// Apply Filters to Table
function applyFilters(containerId) {
  const table = document.getElementById(containerId).querySelector('table');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  const headers = table.querySelectorAll('thead th');

  if (!filters[containerId]) filters[containerId] = {};

  rows.forEach(row => {
    let showRow = true;
    headers.forEach((th, colIndex) => {
      const dropdown = th.querySelector('.filter-dropdown-content');
      if (dropdown) {
        const selectedValues = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
          .map(cb => cb.value);
        const cellValue = row.cells[colIndex].textContent.trim();
        if (selectedValues.length > 0 && !selectedValues.includes(cellValue)) {
          showRow = false;
        }
      }
    });
    row.style.display = showRow ? '' : 'none';
  });
}

// Select All Options
function selectAllOptions(optionsDiv, containerId, colIndex) {
  const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
  applyFilters(containerId);
}

// Clear Filter
function clearFilter(containerId, colIndex) {
  const table = document.getElementById(containerId).querySelector('table');
  const th = table.querySelectorAll('thead th')[colIndex];
  const dropdown = th.querySelector('.filter-dropdown-content');
  const input = dropdown.querySelector('.filter-input');
  const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
  input.value = '';
  checkboxes.forEach(cb => cb.checked = true);
  applyFilters(containerId);
}

// Reset All Filters
function resetFilters(containerId) {
  const table = document.getElementById(containerId).querySelector('table');
  if (table) {
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => row.style.display = '');
    delete filters[containerId];
  }
}

// Close Dropdowns on Click Outside
document.addEventListener('click', function (event) {
  const dropdowns = document.querySelectorAll('.filter-dropdown-content');
  dropdowns.forEach(dropdown => {
    if (!dropdown.parentElement.contains(event.target)) {
      dropdown.classList.remove('show');
    }
  });
});

// Update displayData to Reapply Filters
function displayData(data, containerId, headers, sheetType) {
  const container = document.getElementById(containerId);
  let html = '<table><thead><tr>';
  headers.forEach(header => html += `<th>${header}</th>`);
  html += '</tr></thead><tbody>';
  data.forEach((row, rowIndex) => {
    html += `<tr data-row="${rowIndex}" data-sheet="${sheetType}">`;
    headers.forEach((_, colIndex) => {
      const cell = row[colIndex];
      const value = typeof cell === 'number' && (cell > 40000 && cell < 50000) ? formatDate(cell) : (cell === undefined || cell === null ? '' : cell);
      const isEditable = colIndex > 0;
      html += `<td contenteditable="${isEditable}" data-col="${colIndex}">${value}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
  const table = container.querySelector('table');
  table.addEventListener('input', handleCellEdit);
  if (filterEnabled) toggleFilters(); // Reapply filters if enabled
}
</script>


    
    <script>
      function showInstructions() {
        document.getElementById("instructions-modal").style.display = "block";
      }
      function hideInstructions() {
        document.getElementById("instructions-modal").style.display = "none";
      }
      window.onclick = function(event) {
        var modal = document.getElementById("instructions-modal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
        
    </script>
    <button class="instructions-btn" onclick="showInstructions()" aria-label="View Instructions">
      <i class="fas fa-info-circle"></i>
    </button>
    <a href="https://wa.me/9716804520" class="whatsapp-btn" target="_blank" rel="noopener noreferrer" aria-label="Chat on WhatsApp">
      <i class="fab fa-whatsapp"></i>
    </a>
 <div id="instructions-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="hideInstructions()"></span>
    <h2>GST Reconciliation Tool</h2>
    <h3>How to Use the Tool</h3>
    <ol>
      <li>Download the sample Excel file from the link to understand the format.</li>
      <li>Copy and paste your GSTR-2B data into the "GST Portal" sheet from column B.</li>
      <li>Copy and paste your GSTR-3B or books data into the "Client Data" sheet from column B.</li>
      <li>Upload your Excel file on the GST Reconciliation Tool website.</li>
      <li>Set the "Difference Allowed" value (default is 1) to adjust matching tolerance.</li>
      <li>Check "Detailed Reconciliation" for specific match criteria, or leave unchecked for simple Match/Unmatch view.</li>
      <li>Review the tables (GSTR-2B, GSTR-3B, and Summary) for results.</li>
      <li>User can edit values directly on website if needed.</li>
      <li>Download the reconciled output file by clicking "Download Reconciled Data".</li>
      <li>For support, contact Sumit Garg via WhatsApp 9716804520 (click on WhatsApp icon).</li>
    </ol><br>
    <h3>Matching Heading Criteria</h3><br>
    <p><strong>When Detailed Reconciliation is checked:</strong></p>
    <ol>
      <li><strong>Match - GSTN, Invoice No., Date</strong> - Matches based on GSTN, Invoice No., and Date.</li>
      <li><strong>Match - GSTN, Invoice No.</strong> - Matches based on GSTN and Invoice No.</li>
      <li><strong>Match - GSTN, Date</strong> - Matches based on GSTN and Date.</li>
      <li><strong>Match - GSTN</strong> - Matches based on GSTN only.</li>
      <li><strong>Unmatch - GSTN Not Exist</strong> - GSTN not found in other sheet.</li>
      <li><strong>Unmatch - Amt Diff</strong> - GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
      <li><strong>Unmatch</strong> - Other reasons, generally due to extra invoices in either GST-2B or GSTR-3B/Books</li>
    </ol>
    <p><strong>When Detailed Reconciliation is unchecked:</strong></p>
    <ol>
      <li><strong>Match</strong> - Any of the above match conditions met.</li>
      <li><strong>Unmatch - GSTN Not Exist</strong> - GSTN not found in other sheet.</li>
      <li><strong>Unmatch - Amt Diff</strong> - GSTN and Invoice Number match, but amounts (Taxable Value, IGST, CGST, SGST) differ by more than the allowed difference.</li>
      <li><strong>Unmatch</strong> - Other reasons, generally due to extra invoices in either GST-2B or GSTR-3B/Books</li>
    </ol>
  </div>
</div>
  </body>
  <footer>
<div class="footer-links">
      <a href="#">📞 Ph : 9716804520</a>
      <a href="#">✉️ Email: Sumitgarg100000@gmail.com</a>
      <a href="#">📍 Address: Rohini, Delhi-110086</a>
    </div>
    <div class="footer-links">
      <a href="#">Privacy Policy</a>
      <a href="#">Terms of Service</a>
      <a href="#"></a>
    </div>
  </footer>
</html>
